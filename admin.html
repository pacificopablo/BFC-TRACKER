<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center shadow">
    <h1 class="text-2xl font-bold">Baccarat Fund Admin</h1>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Logout</button>
  </header>

  <!-- Main -->
  <main class="p-6 space-y-6">

    <!-- Section: Stats -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-2">📊 Member Overview</h2>
      <canvas id="memberChart" height="100"></canvas>
    </section>

    <!-- Section: Member List -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">👥 Member List</h2>
        <button id="exportCSV" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">Export CSV</button>
      </div>
      <table class="w-full text-sm">
        <thead class="text-left text-gray-400 border-b border-gray-600">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Shares</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="memberTableBody" class="text-gray-300">
          <!-- JS will populate -->
        </tbody>
      </table>
    </section>

    <!-- Section: Withdrawal Requests -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-2">📝 Withdrawal Requests</h2>
      <div id="withdrawalRequestsContainer" class="space-y-2 text-sm">
        <!-- JS will populate -->
      </div>
    </section>

    <!-- Section: Transaction Log -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-2">🔁 Share Transaction History</h2>
      <table class="w-full text-sm">
        <thead class="text-left text-gray-400 border-b border-gray-600">
          <tr>
            <th>Member</th>
            <th>Type</th>
            <th>Shares</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="transactionTableBody" class="text-gray-300">
          <!-- JS will populate -->
        </tbody>
      </table>
    </section>

  </main>

  <!-- Scripts -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      collection, onSnapshot, doc, updateDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Redirect if not logged in
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth);
    });

    // Member Chart
    const ctx = document.getElementById('memberChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Approved', 'Pending'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['#10B981', '#F59E0B'],
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    // Member List + Chart Data
    const memberTable = document.getElementById("memberTableBody");
    const membersRef = collection(db, "members");
    onSnapshot(membersRef, (snapshot) => {
      memberTable.innerHTML = "";
      let approved = 0, pending = 0;
      snapshot.forEach(doc => {
        const m = doc.data();
        if (m.status === "Approved") approved++;
        else pending++;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${m.name}</td>
          <td>${m.email}</td>
          <td>${m.shares || 0}</td>
          <td class="${m.status === 'Approved' ? 'text-green-400' : 'text-yellow-400'}">${m.status}</td>
        `;
        memberTable.appendChild(row);
      });
      chart.data.datasets[0].data = [approved, pending];
      chart.update();
    });

    // Withdrawal Requests
    const withdrawalContainer = document.getElementById("withdrawalRequestsContainer");
    const withdrawalsRef = collection(db, "withdrawals");
    onSnapshot(withdrawalsRef, (snapshot) => {
      withdrawalContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const r = doc.data();
        if (r.status === "Approved" || r.status === "Rejected") return;

        const div = document.createElement("div");
        div.classList.add("bg-gray-700", "p-3", "rounded");
        div.innerHTML = `
          <div><strong>${r.name}</strong> requested <span class="text-green-400">$${r.amount}</span> on ${r.date}</div>
          <div class="mt-2">
            <button class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs" onclick="approve('${doc.id}')">Approve</button>
            <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs ml-2" onclick="reject('${doc.id}')">Reject</button>
          </div>
        `;
        withdrawalContainer.appendChild(div);
      });
    });

    // Approve/Reject functions
    window.approve = async function (id) {
      await updateDoc(doc(db, "withdrawals", id), { status: "Approved" });
    };

    window.reject = async function (id) {
      await updateDoc(doc(db, "withdrawals", id), { status: "Rejected" });
    };

    // Export to CSV
    document.getElementById("exportCSV").addEventListener("click", async () => {
      const snapshot = await getDocs(membersRef);
      const rows = [["Name", "Email", "Shares", "Status"]];
      snapshot.forEach(doc => {
        const m = doc.data();
        rows.push([m.name, m.email, m.shares || 0, m.status]);
      });

      const csv = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "members.csv";
      a.click();
    });

    // Transaction History
    const transactionTable = document.getElementById("transactionTableBody");
    const transactionsRef = collection(db, "transactions");
    onSnapshot(transactionsRef, (snapshot) => {
      transactionTable.innerHTML = "";
      snapshot.forEach(doc => {
        const t = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.memberName}</td>
          <td class="${t.type === 'buy' ? 'text-green-400' : 'text-red-400'}">${t.type}</td>
          <td>${t.shares}</td>
          <td>${t.date}</td>
        `;
        transactionTable.appendChild(row);
      });
    });
  </script>
</body>
</html>
