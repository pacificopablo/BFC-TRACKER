<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baccarat Fund Member Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white min-h-screen p-4">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold flex items-center">
        <span class="mr-2" aria-hidden="true">ðŸ‘‘</span> Baccarat Fund Member Dashboard
      </h1>
      <div class="flex space-x-2">
        <button
          id="serverTimeBtn"
          class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Show server time"
        >
          Server Time
        </button>
        <button
          id="logoutBtn"
          class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
          aria-label="Log out"
        >
          Logout
        </button>
      </div>
    </header>

    <!-- Member Details -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ‘¤ Your Account</h2>
      <div id="memberDetails" class="space-y-2" aria-live="polite">
        <p><strong>Name:</strong> <span id="memberName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="memberEmail">Loading...</span></p>
        <p><strong>Status:</strong> <span id="memberStatus" class="px-2 py-1 rounded">Loading...</span></p>
        <p><strong>Shares:</strong> <span id="memberShares">Loading...</span></p>
        <p><strong>Balance:</strong> â‚±<span id="memberBalance">Loading...</span></p>
        <p><strong>Approval Date:</strong> <span id="memberApprovalDate">Loading...</span></p>
        <p><strong>Last Distribution:</strong> <span id="memberLastDistribution">Loading...</span></p>
      </div>
    </div>

    <!-- Fund Growth Chart -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ“Š Fund Growth</h2>
      <canvas id="fundChart" height="100" aria-label="Fund growth chart"></canvas>
    </div>

    <!-- Submit Transaction Request -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ’¸ Submit Transaction Request</h2>
      <form id="transactionForm" class="space-y-4" novalidate>
        <div>
          <label for="transactionType" class="block text-sm mb-1">Transaction Type</label>
          <select
            id="transactionType"
            class="w-full p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-500"
            required
            aria-required="true"
          >
            <option value="deposit">Deposit</option>
            <option value="cashout">Cash Out</option>
          </select>
        </div>
        <div>
          <label for="transactionAmount" class="block text-sm mb-1">Amount (â‚±)</label>
          <input
            type="number"
            id="transactionAmount"
            class="w-full p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Enter amount"
            min="0.01"
            step="0.01"
            required
            aria-required="true"
          />
        </div>
        <button
          type="submit"
          id="submitTransactionBtn"
          class="w-full bg-green-600 px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500"
          aria-label="Submit transaction request"
        >
          Submit Request
        </button>
      </form>
      <p id="transactionError" class="text-red-500 text-sm mt-2 hidden" aria-live="assertive"></p>
      <p id="cooldownMessage" class="text-yellow-500 text-sm mt-2 hidden" aria-live="polite"></p>
    </div>

    <!-- Transaction History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ“œ Transaction History</h2>
      <div class="flex flex-col sm:flex-row justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-2">
        <select
          id="historyFilter"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Filter transactions"
        >
          <option value="all">All Transactions</option>
          <option value="deposit">Deposits</option>
          <option value="cashout">Cash Outs</option>
        </select>
        <select
          id="historySort"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Sort transactions"
        >
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div id="historyList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite">
        <div class="flex justify-center items-center h-20" id="historyLoading">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="ml-2 text-gray-400">Loading transactions...</span>
        </div>
      </div>
    </div>

    <!-- Distribution History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">ðŸ“ˆ Distribution History</h2>
      <div id="distributionList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite">
        <div class="flex justify-center items-center h-20" id="distributionLoading">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="ml-2 text-gray-400">Loading distributions...</span>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
        setDoc,
        query,
        where,
        orderBy,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        setPersistence,
        browserSessionPersistence,
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

      // Firebase config (replace with your actual configuration)
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID",
      };

      // Initialize Firebase
      let app;
      let db;
      let auth;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
      } catch (error) {
        console.error("Firebase initialization failed:", error.message);
        document.body.innerHTML = `
          <div class="text-red-500 p-4 text-center">
            Failed to initialize application. Please check your Firebase configuration and try again.
          </div>
        `;
        throw error;
      }

      // Set session persistence
      setPersistence(auth, browserSessionPersistence).catch((error) => {
        console.error("Failed to set session persistence:", error.message);
      });

      // DOM Elements
      const elements = {
        memberName: document.getElementById("memberName"),
        memberEmail: document.getElementById("memberEmail"),
        memberStatus: document.getElementById("memberStatus"),
        memberShares: document.getElementById("memberShares"),
        memberBalance: document.getElementById("memberBalance"),
        memberApprovalDate: document.getElementById("memberApprovalDate"),
        memberLastDistribution: document.getElementById("memberLastDistribution"),
        transactionForm: document.getElementById("transactionForm"),
        transactionType: document.getElementById("transactionType"),
        transactionAmount: document.getElementById("transactionAmount"),
        submitTransactionBtn: document.getElementById("submitTransactionBtn"),
        transactionError: document.getElementById("transactionError"),
        cooldownMessage: document.getElementById("cooldownMessage"),
        historyList: document.getElementById("historyList"),
        historyFilter: document.getElementById("historyFilter"),
        historySort: document.getElementById("historySort"),
        distributionList: document.getElementById("distributionList"),
        historyLoading: document.getElementById("historyLoading"),
        distributionLoading: document.getElementById("distributionLoading"),
        logoutBtn: document.getElementById("logoutBtn"),
        serverTimeBtn: document.getElementById("serverTimeBtn"),
      };

      let allTransactions = [];
      let fundChartInstance = null;
      const SUBMISSION_COOLDOWN = 5000;
      let lastSubmissionTime = 0;
      let cooldownTimer = null;
      let isRedirecting = false;
      let isAuthInitializing = true;

      // Utility Functions
      const formatCurrency = (value) =>
        isNaN(value) ? "0.00" : parseFloat(value).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (element, elementId, message) => {
        element.innerHTML = `
          <div class="text-red-500 p-4 rounded-lg bg-gray-700">
            ${message}
            <button
              class="text-blue-400 underline ml-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onclick="retryLoad('${elementId}')"
              aria-label="Retry loading"
            >
              Retry
            </button>
          </div>
        `;
      };

      const showGlobalError = (message) => {
        elements.transactionError.textContent = message;
        elements.transactionError.classList.remove("hidden");
      };

      const clearGlobalError = () => {
        elements.transactionError.textContent = "";
        elements.transactionError.classList.add("hidden");
      };

      const showLoading = (element, loadingElement) => {
        loadingElement.classList.remove("hidden");
        element.innerHTML = "";
      };

      const hideLoading = (loadingElement) => {
        loadingElement.classList.add("hidden");
      };

      const formatTimestamp = (timestamp) => {
        try {
          return timestamp?.toDate?.()?.toLocaleString("en-PH") || "N/A";
        } catch {
          return "N/A";
        }
      };

      // Get Server Time (PHT)
      async function getServerTime() {
        try {
          const serverDoc = await getDoc(doc(db, "system", "time"));
          return serverDoc.exists() ? serverDoc.data().time?.toDate() : new Date();
        } catch {
          return new Date(Date.now() + 8 * 60 * 60 * 1000); // Fallback to PHT
        }
      }

      // Load Member Details
      async function loadMemberDetails(userId) {
        try {
          showLoading(elements.memberDetails, elements.memberDetails);
          const userDoc = await getDoc(doc(db, "users", userId));
          if (!userDoc.exists()) {
            showError(elements.memberDetails, "memberDetails", "Member data not found.");
            return;
          }
          const data = userDoc.data();
          elements.memberName.textContent = data.name || "N/A";
          elements.memberEmail.textContent = data.email || "N/A";
          elements.memberStatus.textContent = data.status || "N/A";
          elements.memberStatus.className = `px-2 py-1 rounded ${
            data.status === "approved"
              ? "bg-green-600"
              : data.status === "pending"
              ? "bg-yellow-600"
              : "bg-red-600"
          }`;
          elements.memberShares.textContent = data.shares || 0;
          elements.memberBalance.textContent = formatCurrency(data.balance);
          elements.memberApprovalDate.textContent = formatTimestamp(data.approvalDate);
          elements.memberLastDistribution.textContent = formatTimestamp(data.lastDistribution);
        } catch (error) {
          showError(elements.memberDetails, "memberDetails", "Failed to load member details: " + error.message);
        }
      }

      // Initialize Chart
      function initializeChart() {
        if (fundChartInstance) fundChartInstance.destroy();
        const ctx = document.getElementById("fundChart").getContext("2d");
        fundChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Fund Balance",
                data: [],
                backgroundColor: "rgba(59, 130, 246, 0.2)",
                borderColor: "rgba(59, 130, 246, 1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: "white" } } },
            scales: {
              x: { ticks: { color: "white" } },
              y: {
                ticks: { color: "white", callback: (value) => `â‚±${formatCurrency(value)}` },
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Update Chart
      function updateChart() {
        const q = query(collection(db, "profit_distributions"), orderBy("timestamp", "asc"));
        onSnapshot(
          q,
          async (snapshot) => {
            try {
              const fundSnap = await getDocs(collection(db, "fund"));
              const initialBalance = fundSnap.empty ? 0 : fundSnap.docs[0].data().balance || 0;
              const labels = [];
              const data = [];
              let balance = initialBalance;

              snapshot.docs.forEach((doc) => {
                const d = doc.data();
                const timestamp = d.timestamp?.toDate?.();
                if (!timestamp) return;
                const date = timestamp.toLocaleDateString("en-PH", { month: "short", day: "numeric" });
                if (!labels.includes(date)) {
                  labels.push(date);
                  balance += d.type === "profit" ? d.amount : -d.amount;
                  data.push(balance);
                }
              });

              if (labels.length === 0) {
                const now = await getServerTime();
                labels.push(now.toLocaleDateString("en-PH", { month: "short", day: "numeric" }));
                data.push(initialBalance);
              }

              fundChartInstance.data.labels = labels;
              fundChartInstance.data.datasets[0].data = data;
              fundChartInstance.update();
            } catch (error) {
              showGlobalError("Failed to update chart: " + error.message);
            }
          },
          (error) => {
            showGlobalError("Failed to load chart data: " + error.message);
          }
        );
      }

      // Load Transaction History
      function loadTransactionHistory(userId) {
        showLoading(elements.historyList, elements.historyLoading);
        const q = query(
          collection(db, "transactions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            allTransactions = snapshot.docs.map((doc) => {
              const data = doc.data();
              return {
                id: doc.id,
                type: data.type === "deposit" ? "Deposit" : data.type === "cashout" ? "Cash Out" : "Unknown",
                filterType: data.type || "unknown",
                amount: data.amount || 0,
                timestamp: data.timestamp || null,
                status: data.status || "N/A",
              };
            });
            hideLoading(elements.historyLoading);
            displayTransactionHistory();
          },
          (error) => {
            hideLoading(elements.historyLoading);
            showError(elements.historyList, "historyList", `Failed to load transaction history: ${error.message}`);
          }
        );
      }

      // Display Transaction History
      function displayTransactionHistory() {
        const filter = elements.historyFilter.value;
        const sort = elements.historySort.value;
        let filtered = filter === "all" ? allTransactions : allTransactions.filter((t) => t.filterType === filter);
        filtered = filtered.sort((a, b) => {
          const aTime = a.timestamp ? a.timestamp : new Date(0);
          const bTime = b.timestamp ? b.timestamp : new Date(0);
          return sort === "desc" ? bTime - aTime : aTime - bTime;
        });

        elements.historyList.innerHTML = filtered.length
          ? filtered
              .map(
                (t) => `
            <div class="bg-gray-700 p-4 rounded-lg shadow-sm">
              <p><strong>Type:</strong> ${t.type}</p>
              <p><strong>Amount:</strong> â‚±${formatCurrency(t.amount)}</p>
              <p><strong>Date:</strong> ${formatTimestamp(t.timestamp)}</p>
              <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
                t.status === "approved"
                  ? "bg-green-600"
                  : t.status === "pending"
                  ? "bg-yellow-600"
                  : "bg-red-600"
              }">${t.status}</span></p>
            </div>
          `
              )
              .join("")
          : '<p class="text-gray-400 p-4">No transactions found.</p>';
      }

      // Load Distribution History
      function loadDistributionHistory(userId) {
        showLoading(elements.distributionList, elements.distributionLoading);
        const q = query(
          collection(db, "member_distributions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            hideLoading(elements.distributionLoading);
            elements.distributionList.innerHTML = snapshot.docs.length
              ? snapshot.docs
                  .map((doc) => {
                    const data = doc.data();
                    return `
            <div class="bg-gray-700 p-4 rounded-lg shadow-sm">
              <p><strong>Type:</strong> ${data.type === "profit" ? "Profit" : data.type === "loss" ? "Loss" : "Unknown"}</p>
              <p><strong>Amount:</strong> ${data.type === "profit" ? "+" : "-"}â‚±${formatCurrency(data.amount || 0)}</p>
              <p><strong>Date:</strong> ${formatTimestamp(data.timestamp)}</p>
            </div>
          `;
                  })
                  .join("")
              : '<p class="text-gray-400 p-4">No distributions found.</p>';
          },
          (error) => {
            hideLoading(elements.distributionLoading);
            showError(elements.distributionList, "distributionList", `Failed to load distribution history: ${error.message}`);
          }
        );
      }

      // Debounce Filter/Sort Changes
      let debounceTimeout;
      function debounceDisplayTransactionHistory() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(displayTransactionHistory, 300);
      }

      // Submit Transaction Request
      elements.transactionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearGlobalError();
        const now = Date.now();
        if (now - lastSubmissionTime < SUBMISSION_COOLDOWN) {
          const remaining = SUBMISSION_COOLDOWN - (now - lastSubmissionTime);
          elements.cooldownMessage.textContent = `Please wait ${Math.ceil(remaining / 1000)} seconds before submitting again.`;
          elements.cooldownMessage.classList.remove("hidden");
          elements.submitTransactionBtn.disabled = true;
          if (!cooldownTimer) {
            cooldownTimer = setInterval(() => {
              const timeLeft = SUBMISSION_COOLDOWN - (Date.now() - lastSubmissionTime);
              if (timeLeft <= 0) {
                elements.cooldownMessage.textContent = "";
                elements.cooldownMessage.classList.add("hidden");
                elements.submitTransactionBtn.disabled = false;
                clearInterval(cooldownTimer);
                cooldownTimer = null;
              } else {
                elements.cooldownMessage.textContent = `Please wait ${Math.ceil(timeLeft / 1000)} seconds before submitting again.`;
              }
            }, 1000);
          }
          return;
        }
        lastSubmissionTime = now;
        elements.submitTransactionBtn.disabled = true;

        try {
          const type = elements.transactionType.value;
          const amount = parseFloat(elements.transactionAmount.value);
          if (isNaN(amount) || amount <= 0) {
            throw new Error("Amount must be a positive number.");
          }

          const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
          if (!userDoc.exists()) {
            throw new Error("Member data not found.");
          }

          const userData = userDoc.data();
          if (type === "cashout" && (userData.balance || 0) < amount) {
            throw new Error("Insufficient balance for cash out.");
          }

          await setDoc(doc(collection(db, "transactions")), {
            memberId: auth.currentUser.uid,
            memberName: userData.name || "N/A",
            type,
            amount,
            status: "pending",
            timestamp: serverTimestamp(),
          });

          elements.transactionForm.reset();
          alert(`Transaction request (${type}) of â‚±${formatCurrency(amount)} submitted successfully!`);
        } catch (error) {
          showGlobalError(error.message);
        } finally {
          elements.submitTransactionBtn.disabled = false;
        }
      });

      // Event Listeners
      elements.historyFilter.addEventListener("change", debounceDisplayTransactionHistory);
      elements.historySort.addEventListener("change", debounceDisplayTransactionHistory);

      elements.logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          isRedirecting = true;
          window.location.href = "/signin.html";
        } catch (error) {
          showGlobalError("Failed to log out: " + error.message);
        }
      });

      elements.serverTimeBtn.addEventListener("click", async () => {
        const time = await getServerTime();
        alert(`Server Time: ${time.toLocaleString("en-PH")} (PHT)`);
      });

      // Retry Function
      function retryLoad(type) {
        const user = auth.currentUser;
        if (!user) {
          showError(
            type === "transaction" ? elements.historyList : type === "distribution" ? elements.distributionList : elements.memberDetails,
            type === "transaction" ? "historyList" : type === "distribution" ? "distributionList" : "memberDetails",
            "Please log in to retry."
          );
          return;
        }
        if (type === "transaction") loadTransactionHistory(user.uid);
        else if (type === "distribution") loadDistributionHistory(user.uid);
        else if (type === "memberDetails") loadMemberDetails(user.uid);
      }

      window.retryLoad = retryLoad;

      // Auth Check with Robust Initialization
      function initializeAuth() {
        return new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            isAuthInitializing = false;
            reject(new Error("Authentication initialization timed out"));
          }, 10000); // 10-second timeout

          onAuthStateChanged(
            auth,
            (user) => {
              clearTimeout(timeout);
              isAuthInitializing = false;
              if (user) {
                // Force token refresh to ensure session validity
                user.getIdToken(true).catch((error) => {
                  console.error("Token refresh failed:", error.message);
                });
                resolve(user);
              } else if (!isRedirecting) {
                isRedirecting = true;
                showGlobalError("Session expired or not logged in. Redirecting to sign-in page...");
                setTimeout(() => {
                  window.location.href = "/signin.html";
                }, 5000); // 5-second delay for user feedback
              }
            },
            (error) => {
              clearTimeout(timeout);
              isAuthInitializing = false;
              reject(error);
            }
          );
        });
      }

      // Initialize Dashboard
      initializeAuth()
        .then((user) => {
          initializeChart();
          loadMemberDetails(user.uid).then(() => {
            loadTransactionHistory(user.uid);
            loadDistributionHistory(user.uid);
            updateChart();
          });
        })
        .catch((error) => {
          showGlobalError(`Authentication error: ${error.message}. Please try refreshing the page or signing in again.`);
          console.error("Auth initialization error:", error.message);
        });
    </script>
  </body>
</html>
