<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baccarat Fund Member Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      }
      .card {
        background: rgba(31, 41, 55, 0.95);
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        background: linear-gradient(to right, #3b82f6, #1d4ed8);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        color: white;
        font-weight: 500;
      }
      .btn-primary:hover {
        background: linear-gradient(to right, #2563eb, #1e40af);
      }
      .error {
        animation: fadeOut 5s forwards;
      }
      @keyframes fadeOut {
        0% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; display: none; }
      }
    </style>
  </head>
  <body class="text-white min-h-screen p-4 sm:p-6">
    <div id="errorMessage" class="text-red-500 text-center mb-4 hidden"></div>
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Member Dashboard</h1>
        <div class="mt-4 sm:mt-0 flex space-x-4">
          <button id="serverTimeBtn" class="btn-primary">Server Time</button>
          <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded-md hover:bg-red-700">Logout</button>
        </div>
      </header>

      <!-- Profile -->
      <div class="card mb-6">
        <h2 class="text-lg font-semibold mb-4">Profile</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <p><strong>Name:</strong> <span id="profileName">Loading...</span></p>
          <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
          <p><strong>Status:</strong> <span id="profileStatus" class="px-2 py-1 rounded">Loading...</span></p>
          <p><strong>Approval Date:</strong> <span id="profileApprovalDate">Loading...</span></p>
        </div>
      </div>

      <!-- Summary -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="card">
          <h3 class="text-md font-semibold">Shares</h3>
          <p id="shares" class="text-2xl font-bold">0</p>
        </div>
        <div class="card">
          <h3 class="text-md font-semibold">Balance</h3>
          <p id="balance" class="text-2xl font-bold">₱0.00</p>
        </div>
        <div class="card">
          <h3 class="text-md font-semibold">Last Distribution</h3>
          <p id="lastDistribution" class="text-md">None</p>
        </div>
      </div>

      <!-- Transaction Form -->
      <div class="card mb-6">
        <h2 class="text-lg font-semibold mb-4">Transaction Request</h2>
        <form id="transactionForm" class="flex flex-col sm:flex-row gap-4">
          <select id="transactionType" class="bg-gray-700 p-2 rounded-md">
            <option value="deposit">Deposit</option>
            <option value="cashout">Cash Out</option>
          </select>
          <input
            id="transactionAmount"
            type="number"
            step="0.01"
            min="0"
            placeholder="Amount (₱)"
            class="bg-gray-700 p-2 rounded-md"
          />
          <button id="submitTransaction" type="submit" class="btn-primary">Submit</button>
        </form>
        <p id="transactionError" class="text-red-500 mt-2 hidden error"></p>
      </div>

      <!-- Transaction History -->
      <div class="card mb-6">
        <h2 class="text-lg font-semibold mb-4">Transaction History</h2>
        <div id="transactionHistory" class="space-y-2"></div>
      </div>

      <!-- Daily Distribution Report -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Daily Distribution Report</h2>
        <div id="dailyReport" class="space-y-2"></div>
      </div>
    </body>
      <script type="module">
        import { auth, db } from "./firebase-config.js";
        import {
          doc,
          getDoc,
          setDoc,
          collection,
          query,
          where,
          orderBy,
          getDocs,
          serverTimestamp,
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // DOM Elements
        const elements = {
          errorMessage: document.getElementById("errorMessage"),
          profileName: document.getElementById("profileName"),
          profileEmail: document.getElementById("profileEmail"),
          profileStatus: document.getElementById("profileStatus"),
          profileApprovalDate: document.getElementById("profileApprovalDate"),
          shares: document.getElementById("shares"),
          balance: document.getElementById("balance"),
          lastDistribution: document.getElementById("lastDistribution"),
          transactionForm: document.getElementById("transactionForm"),
          transactionType: document.getElementById("transactionType"),
          transactionAmount: document.getElementById("transactionAmount"),
          submitTransaction: document.getElementById("submitTransaction"),
          transactionError: document.getElementById("transactionError"),
          transactionHistory: document.getElementById("transactionHistory"),
          dailyReport: document.getElementById("dailyReport"),
          serverTimeBtn: document.getElementById("serverTimeBtn"),
          logoutBtn: document.getElementById("logoutBtn"),
        };

        let currentUser = null;

        // Utility Functions
        const formatCurrency = (value) =>
          parseFloat(value || 0).toLocaleString("en-PH", { style: "currency", currency: "PHP" });

        const formatDate = (date) =>
          date && !isNaN(new Date(date).getTime()) ? new Date(date).toLocaleString("en-PH") : "None";

        const showError = (message) => {
          elements.errorMessage.textContent = message;
          elements.errorMessage.classList.remove("hidden");
          console.error("Error:", message);
          setTimeout(() => elements.errorMessage.classList.add("hidden"), 5000);
        };

        const showLoading = (element, message = "Loading...") => {
          element.innerHTML = `<p class="text-gray-400">${message}</p>`;
        };

        // Load User Data
        async function loadUserData(userId) {
          console.log("Loading data for userId:", userId);
          showLoading(elements.transactionHistory, "Loading transactions...");
          showLoading(elements.dailyReport, "Loading daily report...");
          elements.profileName.textContent = "Loading...";
          elements.profileEmail.textContent = "Loading...";
          elements.profileStatus.textContent = "Loading...";
          elements.profileApprovalDate.textContent = "Loading...";
          elements.shares.textContent = "0";
          elements.balance.textContent = "₱0.00";
          elements.lastDistribution.textContent = "None";

          try {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            console.log("User snapshot exists:", userSnap.exists());

            if (!userSnap.exists()) {
              console.log("Creating default user document...");
              await setDoc(userRef, {
                name: "New Member",
                email: auth.currentUser.email || "no-email@default.com",
                status: "pending",
                shares: 0,
                balance: 0,
                approvalDate: null,
                lastDistribution: null,
              });
              currentUser = {
                id: userId,
                name: "New Member",
                email: auth.currentUser.email || "no-email@default.com",
                status: "pending",
                shares: 0,
                balance: 0,
                approvalDate: null,
                lastDistribution: null,
              };
            } else {
              currentUser = { id: userSnap.id, ...userSnap.data() };
              console.log("User data:", currentUser);
            }

            elements.profileName.textContent = currentUser.name || "N/A";
            elements.profileEmail.textContent = currentUser.email || "N/A";
            elements.profileStatus.textContent = currentUser.status || "Pending";
            elements.profileStatus.className = `px-2 py-1 rounded ${
              currentUser.status === "approved" ? "bg-green-600" : "bg-yellow-600"
            }`;
            elements.profileApprovalDate.textContent = formatDate(currentUser.approvalDate);
            elements.shares.textContent = currentUser.shares || 0;
            elements.balance.textContent = formatCurrency(currentUser.balance);
            elements.lastDistribution.textContent = formatDate(currentUser.lastDistribution);

            await loadTransactionHistory(userId);
            await loadDailyReport(userId);
          } catch (error) {
            showError(`Failed to load user data: ${error.message}`);
            console.error("Load user data error:", error);
          }
        }

        // Load Transaction History
        async function loadTransactionHistory(userId) {
          showLoading(elements.transactionHistory, "Loading transactions...");
          try {
            const transactionsQuery = query(
              collection(db, "transactions"),
              where("memberId", "==", userId),
              orderBy("timestamp", "desc")
            );
            const distributionsQuery = query(
              collection(db, "member_distributions"),
              where("memberId", "==", userId),
              orderBy("timestamp", "desc")
            );

            const [transactionSnap, distributionSnap] = await Promise.all([
              getDocs(transactionsQuery),
              getDocs(distributionsQuery),
            ]);
            console.log("Transactions found:", transactionSnap.size);
            console.log("Distributions found:", distributionSnap.size);

            const transactions = [];
            transactionSnap.docs.forEach((doc) => {
              const data = doc.data();
              transactions.push({
                id: doc.id,
                type: data.type === "deposit" ? "Deposit" : "Cash Out",
                amount: data.amount,
                timestamp: data.timestamp?.toDate() || new Date(),
                status: data.status || "N/A",
              });
            });
            distributionSnap.docs.forEach((doc) => {
              const data = doc.data();
              transactions.push({
                id: doc.id,
                type: data.type === "profit" ? "Profit Distribution" : "Loss Deduction",
                amount: data.amount,
                timestamp: data.timestamp?.toDate() || new Date(),
                status: `Shares: ${data.sharesAdded || 0}`,
              });
            });

            transactions.sort((a, b) => b.timestamp - a.timestamp);
            elements.transactionHistory.innerHTML = "";
            if (transactions.length === 0) {
              elements.transactionHistory.innerHTML = '<p class="text-gray-400">No transactions found.</p>';
              return;
            }

            transactions.forEach((txn) => {
              const div = document.createElement("div");
              div.className = "bg-gray-700 p-3 rounded-md";
              div.innerHTML = `
                <p><strong>Type:</strong> ${txn.type}</p>
                <p><strong>Amount:</strong> ₱${formatCurrency(txn.amount)}</p>
                <p><strong>Date:</strong> ${formatDate(txn.timestamp)}</p>
                <p><strong>Details:</strong> ${txn.status}</p>
              `;
              elements.transactionHistory.appendChild(div);
            });
          } catch (error) {
            showError(`Failed to load transaction history: ${error.message}`);
            console.error("Transaction history error:", error);
            elements.transactionHistory.innerHTML = '<p class="text-red-500">Failed to load transactions.</p>';
          }
        }

        // Load Daily Distribution Report
        async function loadDailyReport(userId) {
          showLoading(elements.dailyReport, "Loading daily report...");
          try {
            const now = new Date();
            const startOfDay = new Date(now.setHours(0, 0, 0, 0));
            const endOfDay = new Date(now.setHours(23, 59, 59, 999));

            const q = query(
              collection(db, "member_distributions"),
              where("memberId", "==", userId),
              where("timestamp", ">=", startOfDay),
              where("timestamp", "<=", endOfDay),
              orderBy("timestamp", "desc")
            );
            const snapshot = await getDocs(q);
            console.log("Daily distributions found:", snapshot.size);

            elements.dailyReport.innerHTML = "";
            if (snapshot.empty) {
              elements.dailyReport.innerHTML = '<p class="text-gray-400">No distributions today.</p>';
              return;
            }

            snapshot.docs.forEach((doc) => {
              const data = doc.data();
              const div = document.createElement("div");
              div.className = "bg-gray-700 p-3 rounded-md";
              div.innerHTML = `
                <p><strong>Type:</strong> ${data.type === "profit" ? "Profit" : "Loss"}</p>
                <p><strong>Amount:</strong> ${data.type === "profit" ? "+" : "-"}₱${formatCurrency(data.amount)}</p>
                <p><strong>Date:</strong> ${formatDate(data.timestamp)}</p>
              `;
              elements.dailyReport.appendChild(div);
            });
          } catch (error) {
            showError(`Failed to load daily report: ${error.message}`);
            console.error("Daily report error:", error);
            elements.dailyReport.innerHTML = '<p class="text-red-500">Failed to load daily report.</p>';
          }
        }

        // Submit Transaction
        elements.transactionForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          elements.submitTransaction.disabled = true;
          elements.submitTransaction.textContent = "Processing...";

          try {
            const type = elements.transactionType.value;
            const amount = parseFloat(elements.transactionAmount.value);
            if (!amount || amount <= 0) {
              showError("Please enter a valid amount.");
              return;
            }
            if (type === "cashout" && (currentUser.balance || 0) < amount) {
              showError("Insufficient balance for cash out.");
              return;
            }

            await setDoc(doc(collection(db, "transactions")), {
              memberId: currentUser.id,
              memberName: currentUser.name || "N/A",
              type,
              amount,
              status: "pending",
              timestamp: serverTimestamp(),
            });

            elements.transactionForm.reset();
            alert(`Submitted ${type} request of ₱${formatCurrency(amount)}`);
            await loadTransactionHistory(currentUser.id);
          } catch (error) {
            showError(`Failed to submit transaction: ${error.message}`);
            console.error("Transaction error:", error);
          } finally {
            elements.submitTransaction.disabled = false;
            elements.submitTransaction.textContent = "Submit";
          }
        });

        // Authentication Check
        onAuthStateChanged(auth, (user) => {
          if (!user) {
            console.log("No user authenticated");
            showError("Not authenticated. Redirecting to login...");
            setTimeout(() => (window.location.href = "/login.html"), 3000);
          } else {
            console.log("Authenticated user:", user.uid, user.email);
            loadUserData(user.uid);
          }
        }, (error) => {
          console.error("Auth error:", error);
          showError(`Authentication error: ${error.message}`);
        });

        // Logout
        elements.logoutBtn.addEventListener("click", async () => {
          try {
            await signOut(auth);
            console.log("Logged out");
            window.location.href = "/login.html";
          } catch (error) {
            showError(`Logout failed: ${error.message}`);
            console.error("Logout error:", error);
          }
        });

        // Server Time
        elements.serverTimeBtn.addEventListener("click", async () => {
          try {
            const tempRef = doc(collection(db, "temp"));
            await setDoc(tempRef, { timestamp: serverTimestamp() });
            const docSnap = await getDoc(tempRef);
            const time = docSnap.exists() ? docSnap.data().timestamp.toDate() : new Date();
            await deleteDoc(tempRef);
            alert(`Server Time: ${time.toLocaleString()}`);
          } catch (error) {
            showError(`Failed to get server time: ${error.message}`);
            console.error("Server time error:", error);
          }
        });
      </script>
    </body>
</html>
