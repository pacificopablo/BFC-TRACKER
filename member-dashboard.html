<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Baccarat Fund Members Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white p-4">
    <!-- Header with Logout Button -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">ðŸ‘¤ Baccarat Fund Members Dashboard</h1>
      <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded text-sm hover:bg-red-700">Logout</button>
    </div>

    <!-- Member Profile -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-2">Profile</h2>
      <p><strong>Name:</strong> <span id="memberName">Loading...</span></p>
      <p><strong>Email:</strong> <span id="memberEmail">Loading...</span></p>
      <p><strong>Status:</strong> <span id="memberStatus">Loading...</span></p>
      <p><strong>Shares:</strong> <span id="memberShares">Loading...</span></p>
      <p><strong>Balance:</strong> â‚±<span id="memberBalance">Loading...</span></p>
    </div>

    <!-- Transaction History -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-2">ðŸ“œ Transaction History</h2>
      <select id="historyFilter" class="p-2 rounded bg-gray-700 text-white mb-2">
        <option value="all">All Transactions</option>
        <option value="deposit">Deposits</option>
        <option value="cashout">Cash Outs</option>
        <option value="profit">Profit Distributions</option>
        <option value="loss">Loss Deductions</option>
      </select>
      <div id="historyList" class="space-y-4 max-h-96 overflow-auto">Loading transaction history...</div>
    </div>

    <!-- Pending Requests -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-2">ðŸ’° Pending Requests</h2>
      <div id="requestsList" class="space-y-4 max-h-96 overflow-auto">Loading requests...</div>
    </div>

    <!-- Request Submission Form -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-4">ðŸ’¸ Submit Request</h2>
      <form id="requestForm" class="flex flex-col space-y-4">
        <div>
          <label class="block text-sm mb-1">Request Type</label>
          <select id="requestType" class="w-full p-2 rounded bg-gray-700 text-white" required>
            <option value="deposit">Deposit</option>
            <option value="cashout">Cash Out</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Amount (â‚±)</label>
          <input
            type="number"
            id="requestAmount"
            class="w-full p-2 rounded bg-gray-700 text-white"
            placeholder="Enter amount"
            required
            min="0"
            step="0.01"
          />
        </div>
        <button
          type="submit"
          id="submitRequestBtn"
          class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
        >
          Submit Request
        </button>
      </form>
      <p id="requestError" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>

    <script type="module">
      // Import Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        onSnapshot,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCN0dBQXoaWh_13lF0ON25otUpeH3OGINQ",
        authDomain: "bfc-tracker.firebaseapp.com",
        projectId: "bfc-tracker",
        storageBucket: "bfc-tracker.firebasestorage.app",
        messagingSenderId: "127052459580",
        appId: "1:127052459580:web:c3d5caa9302238c11cdd39",
        measurementId: "G-PNYRCFJHYM",
      };

      // Initialize Firebase
      let app, db, auth;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
      } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = '<p class="text-red-500 p-4">Failed to initialize Firebase. Please check configuration.</p>';
        return;
      }

      // DOM Elements
      const elements = {
        memberName: document.getElementById("memberName"),
        memberEmail: document.getElementById("memberEmail"),
        memberStatus: document.getElementById("memberStatus"),
        memberShares: document.getElementById("memberShares"),
        memberBalance: document.getElementById("memberBalance"),
        historyList: document.getElementById("historyList"),
        historyFilter: document.getElementById("historyFilter"),
        requestsList: document.getElementById("requestsList"),
        requestForm: document.getElementById("requestForm"),
        requestType: document.getElementById("requestType"),
        requestAmount: document.getElementById("requestAmount"),
        submitRequestBtn: document.getElementById("submitRequestBtn"),
        requestError: document.getElementById("requestError"),
        logoutBtn: document.getElementById("logoutBtn"),
      };

      // Utility Functions
      const formatCurrency = (value) => parseFloat(value || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (element, message) => {
        element.textContent = message;
        element.classList.remove("hidden");
        setTimeout(() => element.classList.add("hidden"), 5000);
      };

      const showLoading = (element, message = "Loading...") => {
        element.innerHTML = `<p class="text-gray-400">${message}</p>`;
      };

      // Load Member Profile
      function loadMemberProfile(userId) {
        showLoading(elements.memberName.parentElement, "Loading profile...");
        const q = query(collection(db, "users"), where("uid", "==", userId));
        onSnapshot(
          q,
          (snapshot) => {
            if (snapshot.empty) {
              elements.memberName.textContent = "N/A";
              elements.memberEmail.textContent = "N/A";
              elements.memberStatus.textContent = "N/A";
              elements.memberShares.textContent = "0";
              elements.memberBalance.textContent = formatCurrency(0);
              console.warn("No user profile found for UID:", userId);
              return;
            }
            const member = snapshot.docs[0].data() || {};
            elements.memberName.textContent = member.name || "N/A";
            elements.memberEmail.textContent = member.email || "N/A";
            elements.memberStatus.textContent = member.status || "N/A";
            elements.memberShares.textContent = member.shares || 0;
            elements.memberBalance.textContent = formatCurrency(member.balance || 0);
          },
          (error) => {
            console.error("Error loading member profile:", error);
            showError(elements.requestError, `Failed to load profile: ${error.message}`);
            elements.memberName.textContent = "N/A";
            elements.memberEmail.textContent = "N/A";
            elements.memberStatus.textContent = "N/A";
            elements.memberShares.textContent = "0";
            elements.memberBalance.textContent = formatCurrency(0);
          }
        );
      }

      // Load Transaction History
      function loadTransactionHistory(userId) {
        showLoading(elements.historyList, "Loading transaction history...");
        const profitQuery = query(collection(db, "profit_distributions"), where("adminId", "==", userId));
        const transactionQuery = query(collection(db, "transactions"), where("memberName", "==", userId));

        onSnapshot(
          profitQuery,
          (profitSnapshot) => {
            onSnapshot(
              transactionQuery,
              (transactionSnapshot) => {
                let allTransactions = [];

                // Process profit/loss distributions
                profitSnapshot.docs.forEach((doc) => {
                  const data = doc.data();
                  allTransactions.push({
                    type: data.type === "profit" ? "Profit Distribution" : "Loss Deduction",
                    filterType: data.type,
                    amount: data.amount,
                    timestamp: data.timestamp?.toDate() || new Date(),
                    details: `Distributed to ${data.memberCount} members, Total Shares: ${data.totalShares}`,
                  });
                });

                // Process deposit/cash out transactions
                transactionSnapshot.docs.forEach((doc) => {
                  const data = doc.data();
                  allTransactions.push({
                    type: data.type === "deposit" ? "Deposit" : "Cash Out",
                    filterType: data.type,
                    amount: data.amount,
                    timestamp: data.timestamp?.toDate() || new Date(),
                    details: `Status: ${data.status || "N/A"}`,
                  });
                });

                displayTransactionHistory(allTransactions);
              },
              (error) => {
                console.error("Error loading transactions:", error);
                showError(elements.requestError, `Failed to load transaction history: ${error.message}`);
                elements.historyList.innerHTML = '<p class="text-red-500">Failed to load transaction history.</p>';
              }
            );
          },
          (error) => {
            console.error("Error loading profit distributions:", error);
            showError(elements.requestError, `Failed to load transaction history: ${error.message}`);
            elements.historyList.innerHTML = '<p class="text-red-500">Failed to load transaction history.</p>';
          }
        );
      }

      // Display Transaction History
      function displayTransactionHistory(transactions) {
        const filter = elements.historyFilter.value;
        let filteredTransactions = transactions;
        if (filter !== "all") {
          filteredTransactions = transactions.filter((txn) => txn.filterType === filter);
        }

        filteredTransactions.sort((a, b) => b.timestamp - a.timestamp); // Newest first

        elements.historyList.innerHTML = "";
        if (filteredTransactions.length === 0) {
          elements.historyList.innerHTML = '<p class="text-gray-400">No transaction history for selected filter.</p>';
          return;
        }

        filteredTransactions.forEach((txn) => {
          const div = document.createElement("div");
          div.className = "bg-gray-700 p-4 rounded";
          div.innerHTML = `
            <p><strong>Type:</strong> ${txn.type}</p>
            <p><strong>Amount:</strong> â‚±${formatCurrency(txn.amount)}</p>
            <p><strong>Date:</strong> ${txn.timestamp.toLocaleString()}</p>
            <p><strong>Details:</strong> ${txn.details}</p>
          `;
          elements.historyList.appendChild(div);
        });
      }

      // Load Pending Requests
      function loadPendingRequests(userId) {
        showLoading(elements.requestsList, "Loading requests...");
        const q = query(collection(db, "transactions"), where("memberName", "==", userId), where("status", "==", "pending"));
        onSnapshot(
          q,
          (snapshot) => {
            elements.requestsList.innerHTML = "";
            if (snapshot.empty) {
              elements.requestsList.innerHTML = '<p class="text-gray-400">No pending requests.</p>';
            } else {
              snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement("div");
                div.className = "bg-gray-700 p-4 rounded";
                div.innerHTML = `
                  <p><strong>Type:</strong> ${data.type === "deposit" ? "Deposit" : "Cash Out"}</p>
                  <p><strong>Amount:</strong> â‚±${formatCurrency(data.amount)}</p>
                  <p><strong>Date:</strong> ${data.timestamp?.toDate().toLocaleString() || "N/A"}</p>
                `;
                elements.requestsList.appendChild(div);
              });
            }
          },
          (error) => {
            console.error("Error loading pending requests:", error);
            showError(elements.requestError, `Failed to load pending requests: ${error.message}`);
            elements.requestsList.innerHTML = '<p class="text-red-500">Failed to load requests.</p>';
          }
        );
      }

      // Submit Request
      elements.requestForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        elements.submitRequestBtn.disabled = true;
        elements.submitRequestBtn.textContent = "Processing...";

        try {
          const type = elements.requestType.value;
          const amount = parseFloat(elements.requestAmount.value);

          if (isNaN(amount) || amount <= 0) {
            showError(elements.requestError, "Please enter a valid amount greater than 0.");
            return;
          }

          const user = auth.currentUser;
          if (!user) {
            showError(elements.requestError, "Not authenticated. Please log in.");
            return;
          }

          await addDoc(collection(db, "transactions"), {
            type,
            amount,
            timestamp: serverTimestamp(),
            memberName: user.displayName || user.email || "Unknown",
            status: "pending",
          });

          elements.requestForm.reset();
          alert(`Request for â‚±${formatCurrency(amount)} (${type}) submitted successfully!`);
        } catch (error) {
          console.error("Error submitting request:", error);
          showError(elements.requestError, `Failed to submit request: ${error.message}`);
        } finally {
          elements.submitRequestBtn.disabled = false;
          elements.submitRequestBtn.textContent = "Submit Request";
        }
      });

      // Logout Functionality
      elements.logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "/login.html";
        } catch (error) {
          console.error("Error logging out:", error);
          showError(elements.requestError, `Failed to logout: ${error.message}`);
        }
      });

      // Filter Transaction History
      elements.historyFilter.addEventListener("change", () => {
        const user = auth.currentUser;
        if (user) loadTransactionHistory(user.uid);
      });

      // Authentication Check and Data Loading
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          showError(elements.requestError, "Not authenticated. Redirecting to login...");
          setTimeout(() => (window.location.href = "/login.html"), 2000);
          return;
        }

        const q = query(collection(db, "users"), where("uid", "==", user.uid));
        onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
            addDoc(collection(db, "users"), {
              uid: user.uid,
              name: user.displayName || "N/A",
              email: user.email || "N/A",
              status: "pending",
              shares: 0,
              balance: 0,
            }).then(() => {
              loadMemberProfile(user.uid);
              loadTransactionHistory(user.uid);
              loadPendingRequests(user.uid);
            });
          } else {
            loadMemberProfile(user.uid);
            loadTransactionHistory(user.uid);
            loadPendingRequests(user.uid);
          }
        });
      });
    </script>
  </body>
</html>
