<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baccarat Fund Member Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white min-h-screen p-4">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold flex items-center">
        <span class="mr-2" aria-hidden="true">ðŸ‘‘</span> Baccarat Fund Member Dashboard
      </h1>
      <div class="flex space-x-2">
        <button
          id="serverTimeBtn"
          class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Show server time"
        >
          Server Time
        </button>
        <button
          id="logoutBtn"
          class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
          aria-label="Log out"
        >
          Logout
        </button>
      </div>
    </header>

    <!-- Member Details -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ‘¤ Your Account</h2>
      <div id="memberDetails" class="space-y-2" aria-live="polite">
        <p><strong>Name:</strong> <span id="memberName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="memberEmail">Loading...</span></p>
        <p><strong>Status:</strong> <span id="memberStatus" class="px-2 py-1 rounded">Loading...</span></p>
        <p><strong>Shares:</strong> <span id="memberShares">Loading...</span></p>
        <p><strong>Balance:</strong> â‚±<span id="memberBalance">Loading...</span></p>
        <p><strong>Approval Date:</strong> <span id="memberApprovalDate">Loading...</span></p>
        <p><strong>Last Distribution:</strong> <span id="memberLastDistribution">Loading...</span></p>
      </div>
    </div>

    <!-- Fund Growth Chart -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ“Š Fund Growth</h2>
      <canvas id="fundChart" height="100" aria-label="Fund growth chart"></canvas>
    </div>

    <!-- Submit Transaction Request -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ’¸ Submit Transaction Request</h2>
      <form id="transactionForm" class="space-y-4" novalidate>
        <div>
          <label for="transactionType" class="block text-sm mb-1">Transaction Type</label>
          <select
            id="transactionType"
            class="w-full p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-500"
            required
            aria-required="true"
          >
            <option value="deposit">Deposit</option>
            <option value="cashout">Cash Out</option>
          </select>
        </div>
        <div>
          <label for="transactionAmount" class="block text-sm mb-1">Amount (â‚±)</label>
          <input
            type="number"
            id="transactionAmount"
            class="w-full p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Enter amount"
            min="0.01"
            step="0.01"
            required
            aria-required="true"
          />
        </div>
        <button
          type="submit"
          id="submitTransactionBtn"
          class="w-full bg-green-600 px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500"
          aria-label="Submit transaction request"
        >
          Submit Request
        </button>
      </form>
      <p id="transactionError" class="text-red-500 text-sm mt-2 hidden" aria-live="assertive"></p>
      <p id="cooldownMessage" class="text-yellow-500 text-sm mt-2 hidden" aria-live="polite"></p>
    </div>

    <!-- Transaction History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ“œ Transaction History</h2>
      <div class="flex flex-col sm:flex-row justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-2">
        <select
          id="historyFilter"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Filter transactions"
        >
          <option value="all">All Transactions</option>
          <option value="deposit">Deposits</option>
          <option value="cashout">Cash Outs</option>
        </select>
        <select
          id="historySort"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Sort transactions"
        >
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div id="historyList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite"></div>
    </div>

    <!-- Distribution History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">ðŸ“ˆ Distribution History</h2>
      <div id="distributionList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
        setDoc,
        query,
        where,
        orderBy,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

      // Firebase config should be stored securely (e.g., environment variables)
      const firebaseConfig = {
        // Placeholder: Replace with secure configuration loading
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // DOM Elements
      const elements = {
        memberName: document.getElementById("memberName"),
        memberEmail: document.getElementById("memberEmail"),
        memberStatus: document.getElementById("memberStatus"),
        memberShares: document.getElementById("memberShares"),
        memberBalance: document.getElementById("memberBalance"),
        memberApprovalDate: document.getElementById("memberApprovalDate"),
        memberLastDistribution: document.getElementById("memberLastDistribution"),
        transactionForm: document.getElementById("transactionForm"),
        transactionType: document.getElementById("transactionType"),
        transactionAmount: document.getElementById("transactionAmount"),
        submitTransactionBtn: document.getElementById("submitTransactionBtn"),
        transactionError: document.getElementById("transactionError"),
        cooldownMessage: document.getElementById("cooldownMessage"),
        historyList: document.getElementById("historyList"),
        historyFilter: document.getElementById("historyFilter"),
        historySort: document.getElementById("historySort"),
        distributionList: document.getElementById("distributionList"),
        logoutBtn: document.getElementById("logoutBtn"),
        serverTimeBtn: document.getElementById("serverTimeBtn"),
      };

      let allTransactions = [];
      let fundChartInstance = null;
      const SUBMISSION_COOLDOWN = 5000;
      let lastSubmissionTime = 0;
      let cooldownTimer = null;

      // Utility Functions
      const formatCurrency = (value) =>
        isNaN(value) ? "0.00" : parseFloat(value).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (message) => {
        elements.transactionError.textContent = message;
        elements.transactionError.classList.remove("hidden");
      };

      const clearError = () => {
        elements.transactionError.textContent = "";
        elements.transactionError.classList.add("hidden");
      };

      const showLoading = (element, message = "Loading...") => {
        element.innerHTML = `<p class="text-gray-400">${message}</p>`;
      };

      const updateCooldownMessage = (remaining) => {
        if (remaining > 0) {
          elements.cooldownMessage.textContent = `Please wait ${Math.ceil(remaining / 1000)} seconds before submitting again.`;
          elements.cooldownMessage.classList.remove("hidden");
          elements.submitTransactionBtn.disabled = true;
        } else {
          elements.cooldownMessage.textContent = "";
          elements.cooldownMessage.classList.add("hidden");
          elements.submitTransactionBtn.disabled = false;
        }
      };

      // Get Server Time (PHT)
      async function getServerTime() {
        try {
          const serverDoc = await getDoc(doc(db, "system", "time"));
          return serverDoc.exists() ? serverDoc.data().time?.toDate() : new Date();
        } catch {
          return new Date(Date.now() + 8 * 60 * 60 * 1000); // Fallback to PHT
        }
      }

      // Load Member Details
      async function loadMemberDetails(userId) {
        try {
          showLoading(elements.memberDetails);
          const userDoc = await getDoc(doc(db, "users", userId));
          if (!userDoc.exists()) {
            showError("Member data not found.");
            elements.memberDetails.innerHTML = '<p class="text-red-500">No member data available.</p>';
            return;
          }
          const data = userDoc.data();
          elements.memberName.textContent = data.name || "N/A";
          elements.memberEmail.textContent = data.email || "N/A";
          elements.memberStatus.textContent = data.status || "N/A";
          elements.memberStatus.className = `px-2 py-1 rounded ${
            data.status === "approved"
              ? "bg-green-600"
              : data.status === "pending"
              ? "bg-yellow-600"
              : "bg-red-600"
          }`;
          elements.memberShares.textContent = data.shares || 0;
          elements.memberBalance.textContent = formatCurrency(data.balance);
          elements.memberApprovalDate.textContent = data.approvalDate
            ? new Date(data.approvalDate.toDate?.() || data.approvalDate).toLocaleString("en-PH")
            : "N/A";
          elements.memberLastDistribution.textContent = data.lastDistribution
            ? new Date(data.lastDistribution.toDate?.() || data.lastDistribution).toLocaleString("en-PH")
            : "None";
        } catch (error) {
          showError("Failed to load member details: " + error.message);
          elements.memberDetails.innerHTML = '<p class="text-red-500">Error loading member data.</p>';
        }
      }

      // Initialize Chart
      function initializeChart() {
        if (fundChartInstance) fundChartInstance.destroy();
        const ctx = document.getElementById("fundChart").getContext("2d");
        fundChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Fund Balance",
                data: [],
                backgroundColor: "rgba(59, 130, 246, 0.2)",
                borderColor: "rgba(59, 130, 246, 1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: "white" } } },
            scales: {
              x: { ticks: { color: "white" } },
              y: {
                ticks: { color: "white", callback: (value) => `â‚±${formatCurrency(value)}` },
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Update Chart with Real-Time Data
      function updateChart() {
        const q = query(collection(db, "profit_distributions"), orderBy("timestamp", "asc"));
        onSnapshot(
          q,
          async (snapshot) => {
            try {
              const fundSnap = await getDocs(collection(db, "fund"));
              const initialBalance = fundSnap.empty ? 0 : fundSnap.docs[0].data().balance || 0;
              const labels = [];
              const data = [];
              let balance = initialBalance;

              snapshot.docs.forEach((doc) => {
                const d = doc.data();
                const timestamp = d.timestamp?.toDate?.();
                if (!timestamp) return;
                const date = timestamp.toLocaleDateString("en-PH", { month: "short", day: "numeric" });
                if (!labels.includes(date)) {
                  labels.push(date);
                  balance += d.type === "profit" ? d.amount : -d.amount;
                  data.push(balance);
                }
              });

              if (labels.length === 0) {
                const now = await getServerTime();
                labels.push(now.toLocaleDateString("en-PH", { month: "short", day: "numeric" }));
                data.push(initialBalance);
              }

              fundChartInstance.data.labels = labels;
              fundChartInstance.data.datasets[0].data = data;
              fundChartInstance.update();
            } catch (error) {
              showError("Failed to update chart: " + error.message);
              const now = new Date();
              fundChartInstance.data.labels = [now.toLocaleDateString("en-PH", { month: "short", day: "numeric" })];
              fundChartInstance.data.datasets[0].data = [0];
              fundChartInstance.update();
            }
          },
          (error) => {
            showError("Failed to load chart data: " + error.message);
          }
        );
      }

      // Load Transaction History
      function loadTransactionHistory(userId) {
        showLoading(elements.historyList);
        const q = query(
          collection(db, "transactions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            allTransactions = snapshot.docs.map((doc) => ({
              id: doc.id,
              type: doc.data().type === "deposit" ? "Deposit" : "Cash Out",
              filterType: doc.data().type,
              amount: doc.data().amount || 0,
              timestamp: doc.data().timestamp?.toDate?.() || new Date(),
              status: doc.data().status || "N/A",
            }));
            displayTransactionHistory();
          },
          (error) => {
            showError("Failed to load transaction history: " + error.message);
            elements.historyList.innerHTML = `
              <p class="text-red-500">
                Error loading transaction history.
                <button
                  class="text-blue-400 underline focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onclick="retryLoad('transaction')"
                  aria-label="Retry loading transaction history"
                >
                  Retry
                </button>
              </p>
            `;
          }
        );
      }

      // Display Transaction History
      function displayTransactionHistory() {
        const filter = elements.historyFilter.value;
        const sort = elements.historySort.value;
        let filtered = filter === "all" ? allTransactions : allTransactions.filter((t) => t.filterType === filter);
        filtered.sort((a, b) => (sort === "desc" ? b.timestamp - a.timestamp : a.timestamp - b.timestamp));

        elements.historyList.innerHTML = filtered.length
          ? filtered
              .map(
                (t) => `
            <div class="bg-gray-700 p-4 rounded-lg">
              <p><strong>Type:</strong> ${t.type}</p>
              <p><strong>Amount:</strong> â‚±${formatCurrency(t.amount)}</p>
              <p><strong>Date:</strong> ${t.timestamp.toLocaleString("en-PH")}</p>
              <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
                t.status === "approved"
                  ? "bg-green-600"
                  : t.status === "pending"
                    ? "bg-yellow-600"
                    : "bg-red-600"
              }">${t.status}</span></p>
            </div>
          `
              )
              .join("")
          : '<p class="text-gray-400">No transactions found.</p>';
      }

      // Load Distribution History
      function loadDistributionHistory(userId) {
        showLoading(elements.distributionList);
        const q = query(
          collection(db, "member_distributions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            elements.distributionList.innerHTML = snapshot.docs.length
              ? snapshot.docs
                  .map((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp?.toDate?.();
                    return `
            <div class="bg-gray-700 p-4 rounded-lg">
              <p><strong>Type:</strong> ${data.type === "profit" ? "Profit" : "Loss"}</p>
              <p><strong>Amount:</strong> ${data.type === "profit" ? "+" : "-"}â‚±${formatCurrency(data.amount || 0)}</p>
              <p><strong>Date:</strong> ${timestamp ? timestamp.toLocaleString("en-PH") : "N/A"}</p>
            </div>
          `;
                  })
                  .join("")
              : '<p class="text-gray-400">No distributions found.</p>';
          },
          (error) => {
            showError("Failed to load distribution history: " + error.message);
            elements.distributionList.innerHTML = `
              <p class="text-red-500">
                Error loading distribution history.
                <button
                  class="text-blue-400 underline focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onclick="retryLoad('distribution')"
                  aria-label="Retry loading distribution history"
                >
                  Retry
                </button>
              </p>
            `;
          }
        );
      }

      // Submit Transaction Request
      elements.transactionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();
        const now = Date.now();
        if (now - lastSubmissionTime < SUBMISSION_COOLDOWN) {
          const remaining = SUBMISSION_COOLDOWN - (now - lastSubmissionTime);
          updateCooldownMessage(remaining);
          if (!cooldownTimer) {
            cooldownTimer = setInterval(() => {
              const timeLeft = SUBMISSION_COOLDOWN - (Date.now() - lastSubmissionTime);
              updateCooldownMessage(timeLeft);
              if (timeLeft <= 0) clearInterval(cooldownTimer);
            }, 1000);
          }
          return;
        }
        lastSubmissionTime = now;
        elements.submitTransactionBtn.disabled = true;

        try {
          const type = elements.transactionType.value;
          const amount = parseFloat(elements.transactionAmount.value);
          if (isNaN(amount) || amount <= 0) {
            throw new Error("Amount must be a positive number.");
          }

          const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
          if (!userDoc.exists()) {
            throw new Error("Member data not found.");
          }

          const userData = userDoc.data();
          if (type === "cashout" && (userData.balance || 0) < amount) {
            throw new Error("Insufficient balance for cash out.");
          }

          await setDoc(doc(collection(db, "transactions")), {
            memberId: auth.currentUser.uid,
            memberName: userData.name || "N/A",
            type,
            amount,
            status: "pending",
            timestamp: serverTimestamp(),
          });

          elements.transactionForm.reset();
          alert(`Transaction request (${type}) of â‚±${formatCurrency(amount)} submitted successfully!`);
        } catch (error) {
          showError(error.message);
        } finally {
          elements.submitTransactionBtn.disabled = false;
        }
      });

      // History Filter/Sort
      elements.historyFilter.addEventListener("change", displayTransactionHistory);
      elements.historySort.addEventListener("change", displayTransactionHistory);

      // Logout
      elements.logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "/login.html";
        } catch (error) {
          showError("Failed to log out: " + error.message);
        }
      });

      // Server Time
      elements.serverTimeBtn.addEventListener("click", async () => {
        const time = await getServerTime();
        alert(`Server Time: ${time.toLocaleString("en-PH")} (PHT)`);
      });

      // Retry Function
      function retryLoad(type) {
        const user = auth.currentUser;
        if (user) {
          if (type === "transaction") loadTransactionHistory(user.uid);
          else if (type === "distribution") loadDistributionHistory(user.uid);
        }
      }

      // Expose retryLoad to window for button clicks
      window.retryLoad = retryLoad;

      // Auth Check
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "/login.html";
        } else {
          initializeChart();
          loadMemberDetails(user.uid).then(() => {
            loadTransactionHistory(user.uid);
            loadDistributionHistory(user.uid);
            updateChart();
          });
        }
      });
    </script>
  </body>
</html>
