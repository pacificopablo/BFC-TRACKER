<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baccarat Fund Member Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white min-h-screen p-4">
    <!-- Other sections (Header, Member Details, Fund Growth Chart, Transaction Form) remain unchanged -->

    <!-- Transaction History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-8">
      <h2 class="text-lg font-bold mb-4">ðŸ“œ Transaction History</h2>
      <div class="flex flex-col sm:flex-row justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-2">
        <select
          id="historyFilter"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Filter transactions"
        >
          <option value="all">All Transactions</option>
          <option value="deposit">Deposits</option>
          <option value="cashout">Cash Outs</option>
        </select>
        <select
          id="historySort"
          class="p-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Sort transactions"
        >
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div id="historyList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite">
        <div class="flex justify-center items-center h-20" id="historyLoading">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="ml-2 text-gray-400">Loading transactions...</span>
        </div>
      </div>
    </div>

    <!-- Distribution History -->
    <div class="bg-gray-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">ðŸ“ˆ Distribution History</h2>
      <div id="distributionList" class="space-y-4 max-h-80 overflow-y-auto" aria-live="polite">
        <div class="flex justify-center items-center h-20" id="distributionLoading">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="ml-2 text-gray-400">Loading distributions...</span>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
        setDoc,
        query,
        where,
        orderBy,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

      // Firebase config (replace with secure environment variables)
      const firebaseConfig = {
        // Placeholder: Replace with secure configuration
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // DOM Elements
      const elements = {
        memberName: document.getElementById("memberName"),
        memberEmail: document.getElementById("memberEmail"),
        memberStatus: document.getElementById("memberStatus"),
        memberShares: document.getElementById("memberShares"),
        memberBalance: document.getElementById("memberBalance"),
        memberApprovalDate: document.getElementById("memberApprovalDate"),
        memberLastDistribution: document.getElementById("memberLastDistribution"),
        transactionForm: document.getElementById("transactionForm"),
        transactionType: document.getElementById("transactionType"),
        transactionAmount: document.getElementById("transactionAmount"),
        submitTransactionBtn: document.getElementById("submitTransactionBtn"),
        transactionError: document.getElementById("transactionError"),
        cooldownMessage: document.getElementById("cooldownMessage"),
        historyList: document.getElementById("historyList"),
        historyFilter: document.getElementById("historyFilter"),
        historySort: document.getElementById("historySort"),
        distributionList: document.getElementById("distributionList"),
        historyLoading: document.getElementById("historyLoading"),
        distributionLoading: document.getElementById("distributionLoading"),
        logoutBtn: document.getElementById("logoutBtn"),
        serverTimeBtn: document.getElementById("serverTimeBtn"),
      };

      let allTransactions = [];
      let fundChartInstance = null;
      const SUBMISSION_COOLDOWN = 5000;
      let lastSubmissionTime = 0;
      let cooldownTimer = null;

      // Utility Functions
      const formatCurrency = (value) =>
        isNaN(value) ? "0.00" : parseFloat(value).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (element, message) => {
        element.innerHTML = `
          <div class="text-red-500 p-4 rounded-lg bg-gray-700">
            ${message}
            <button
              class="text-blue-400 underline ml-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onclick="retryLoad('${element.id === 'historyList' ? 'transaction' : 'distribution'}')"
              aria-label="Retry loading"
            >
              Retry
            </button>
          </div>
        `;
      };

      const showLoading = (element, loadingElement) => {
        loadingElement.classList.remove("hidden");
        element.innerHTML = "";
      };

      const hideLoading = (loadingElement) => {
        loadingElement.classList.add("hidden");
      };

      const formatTimestamp = (timestamp) => {
        try {
          return timestamp?.toDate?.()?.toLocaleString("en-PH") || "N/A";
        } catch {
          return "N/A";
        }
      };

      // Get Server Time (PHT)
      async function getServerTime() {
        try {
          const serverDoc = await getDoc(doc(db, "system", "time"));
          return serverDoc.exists() ? serverDoc.data().time?.toDate() : new Date();
        } catch {
          return new Date(Date.now() + 8 * 60 * 60 * 1000); // Fallback to PHT
        }
      }

      // Load Transaction History
      function loadTransactionHistory(userId) {
        showLoading(elements.historyList, elements.historyLoading);
        const q = query(
          collection(db, "transactions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            allTransactions = snapshot.docs.map((doc) => {
              const data = doc.data();
              return {
                id: doc.id,
                type: data.type === "deposit" ? "Deposit" : data.type === "cashout" ? "Cash Out" : "Unknown",
                filterType: data.type || "unknown",
                amount: data.amount || 0,
                timestamp: data.timestamp || null,
                status: data.status || "N/A",
              };
            });
            hideLoading(elements.historyLoading);
            displayTransactionHistory();
          },
          (error) => {
            hideLoading(elements.historyLoading);
            showError(elements.historyList, `Failed to load transaction history: ${error.message}`);
          }
        );
      }

      // Display Transaction History
      function displayTransactionHistory() {
        const filter = elements.historyFilter.value;
        const sort = elements.historySort.value;
        let filtered = filter === "all" ? allTransactions : allTransactions.filter((t) => t.filterType === filter);
        filtered = filtered.sort((a, b) => {
          const aTime = a.timestamp ? a.timestamp : new Date(0);
          const bTime = b.timestamp ? b.timestamp : new Date(0);
          return sort === "desc" ? bTime - aTime : aTime - bTime;
        });

        elements.historyList.innerHTML = filtered.length
          ? filtered
              .map(
                (t) => `
            <div class="bg-gray-700 p-4 rounded-lg shadow-sm">
              <p><strong>Type:</strong> ${t.type}</p>
              <p><strong>Amount:</strong> â‚±${formatCurrency(t.amount)}</p>
              <p><strong>Date:</strong> ${formatTimestamp(t.timestamp)}</p>
              <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
                t.status === "approved"
                  ? "bg-green-600"
                  : t.status === "pending"
                  ? "bg-yellow-600"
                  : "bg-red-600"
              }">${t.status}</span></p>
            </div>
          `
              )
              .join("")
          : '<p class="text-gray-400 p-4">No transactions found.</p>';
      }

      // Load Distribution History
      function loadDistributionHistory(userId) {
        showLoading(elements.distributionList, elements.distributionLoading);
        const q = query(
          collection(db, "member_distributions"),
          where("memberId", "==", userId),
          orderBy("timestamp", "desc")
        );
        onSnapshot(
          q,
          (snapshot) => {
            hideLoading(elements.distributionLoading);
            elements.distributionList.innerHTML = snapshot.docs.length
              ? snapshot.docs
                  .map((doc) => {
                    const data = doc.data();
                    return `
            <div class="bg-gray-700 p-4 rounded-lg shadow-sm">
              <p><strong>Type:</strong> ${data.type === "profit" ? "Profit" : data.type === "loss" ? "Loss" : "Unknown"}</p>
              <p><strong>Amount:</strong> ${data.type === "profit" ? "+" : "-"}â‚±${formatCurrency(data.amount || 0)}</p>
              <p><strong>Date:</strong> ${formatTimestamp(data.timestamp)}</p>
            </div>
          `;
                  })
                  .join("")
              : '<p class="text-gray-400 p-4">No distributions found.</p>';
          },
          (error) => {
            hideLoading(elements.distributionLoading);
            showError(elements.distributionList, `Failed to load distribution history: ${error.message}`);
          }
        );
      }

      // Debounce Filter/Sort Changes
      let debounceTimeout;
      function debounceDisplayTransactionHistory() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(displayTransactionHistory, 300);
      }

      // Other Functions (unchanged from previous response)
      const formatCurrency = (value) => /* ... */;
      const showError = (element, message) => /* ... */;
      // ... (include other functions like loadMemberDetails, initializeChart, updateChart, etc.)

      // Event Listeners
      elements.historyFilter.addEventListener("change", debounceDisplayTransactionHistory);
      elements.historySort.addEventListener("change", debounceDisplayTransactionHistory);

      elements.logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "/signin.html"; // Updated to match previous conversation
        } catch (error) {
          showError(elements.transactionError, "Failed to log out: " + error.message);
        }
      });

      elements.serverTimeBtn.addEventListener("click", async () => {
        const time = await getServerTime();
        alert(`Server Time: ${time.toLocaleString("en-PH")} (PHT)`);
      });

      // Retry Function
      function retryLoad(type) {
        const user = auth.currentUser;
        if (!user) {
          showError(
            type === "transaction" ? elements.historyList : elements.distributionList,
            "Please log in to retry."
          );
          return;
        }
        if (type === "transaction") loadTransactionHistory(user.uid);
        else if (type === "distribution") loadDistributionHistory(user.uid);
      }

      window.retryLoad = retryLoad;

      // Auth Check
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "/signin.html";
        } else {
          initializeChart();
          loadMemberDetails(user.uid).then(() => {
            loadTransactionHistory(user.uid);
            loadDistributionHistory(user.uid);
            updateChart();
          });
        }
      });
    </script>
  </body>
</html>
