<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baccarat Fund - Login & Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      body {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      }
      .card {
        background: rgba(31, 41, 55, 0.95);
        border-radius: 0.5rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        background: linear-gradient(to right, #3b82f6, #1d4ed8);
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        color: white;
        font-weight: 500;
        transition: background 0.3s;
      }
      .btn-primary:hover {
        background: linear-gradient(to right, #2563eb, #1e40af);
      }
      .btn-secondary {
        background: linear-gradient(to right, #6b7280, #4b5563);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        color: white;
        font-weight: 500;
        transition: background 0.3s;
      }
      .btn-secondary:hover {
        background: linear-gradient(to right, #4b5563, #374151);
      }
      .error {
        animation: fadeOut 5s forwards;
      }
      @keyframes fadeOut {
        0% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; display: none; }
      }
    </style>
  </head>
  <body class="text-white min-h-screen flex items-center justify-center p-4 sm:p-6">
    <div class="max-w-md w-full">
      <!-- Error Message -->
      <div id="errorMessage" class="text-red-500 text-center mb-4 hidden" aria-live="polite"></div>

      <!-- Card Container -->
      <div class="card">
        <h1 class="text-2xl font-bold text-center mb-6">Baccarat Fund</h1>

        <!-- Login Form -->
        <div id="loginFormContainer">
          <h2 class="text-lg font-semibold mb-4">Login</h2>
          <form id="loginForm" class="space-y-4">
            <div>
              <label for="loginEmail" class="block text-sm font-medium">Email</label>
              <input
                id="loginEmail"
                type="email"
                required
                aria-describedby="errorMessage"
                class="w-full bg-gray-700 p-2 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter your email"
              />
            </div>
            <div>
              <label for="loginPassword" class="block text-sm font-medium">Password</label>
              <input
                id="loginPassword"
                type="password"
                required
                aria-describedby="errorMessage"
                class="w-full bg-gray-700 p-2 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter your password"
              />
            </div>
            <button id="loginSubmit" type="submit" class="btn-primary w-full">Login</button>
          </form>
          <p class="text-center mt-4">
            Don't have an account? 
            <button id="showSignUp" class="btn-secondary">Sign Up</button>
          </p>
        </div>

        <!-- Sign Up Form -->
        <div id="signUpFormContainer" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Sign Up</h2>
          <form id="signUpForm" class="space-y-4">
            <div>
              <label for="signUpName" class="block text-sm font-medium">Full Name</label>
              <input
                id="signUpName"
                type="text"
                required
                aria-describedby="errorMessage"
                class="w-full bg-gray-700 p-2 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter your full name"
              />
            </div>
            <div>
              <label for="signUpEmail" class="block text-sm font-medium">Email</label>
              <input
                id="signUpEmail"
                type="email"
                required
                aria-describedby="errorMessage"
                class="w-full bg-gray-700 p-2 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter your email"
              />
            </div>
            <div>
              <label for="signUpPassword" class="block text-sm font-medium">Password</label>
              <input
                id="signUpPassword"
                type="password"
                required
                minlength="6"
                aria-describedby="errorMessage"
                class="w-full bg-gray-700 p-2 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Create a password"
              />
            </div>
            <button id="signUpSubmit" type="submit" class="btn-primary w-full">Sign Up</button>
          </form>
          <p class="text-center mt-4">
            Already have an account? 
            <button id="showLogin" class="btn-secondary">Login</button>
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import { auth, db } from "./firebase-config.js";
      import {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      // DOM Elements
      const elements = {
        errorMessage: document.getElementById("errorMessage"),
        loginForm: document.getElementById("loginForm"),
        loginEmail: document.getElementById("loginEmail"),
        loginPassword: document.getElementById("loginPassword"),
        loginSubmit: document.getElementById("loginSubmit"),
        signUpForm: document.getElementById("signUpForm"),
        signUpName: document.getElementById("signUpName"),
        signUpEmail: document.getElementById("signUpEmail"),
        signUpPassword: document.getElementById("signUpPassword"),
        signUpSubmit: document.getElementById("signUpSubmit"),
        loginFormContainer: document.getElementById("loginFormContainer"),
        signUpFormContainer: document.getElementById("signUpFormContainer"),
        showSignUp: document.getElementById("showSignUp"),
        showLogin: document.getElementById("showLogin"),
      };

      // Utility Function to Show Error
      const showError = (message) => {
        elements.errorMessage.textContent = message;
        elements.errorMessage.classList.remove("hidden");
        console.error("Error:", message);
        setTimeout(() => elements.errorMessage.classList.add("hidden"), 5000);
      };

      // Handle Firebase Authentication Errors
      const handleAuthError = (error) => {
        switch (error.code) {
          case "auth/email-already-in-use":
            return "This email is already registered.";
          case "auth/invalid-email":
            return "Invalid email format.";
          case "auth/weak-password":
            return "Password must be at least 6 characters.";
          case "auth/wrong-password":
            return "Incorrect password.";
          case "auth/user-not-found":
            return "No account found with this email.";
          case "auth/too-many-requests":
            return "Too many attempts. Please try again later.";
          default:
            return error.message;
        }
      };

 conjectural      // Utility Function to Toggle Button State
      const toggleButtonState = (button, isLoading) => {
        button.disabled = isLoading;
        button.textContent = isLoading ? "Processing..." : button.id === "loginSubmit" ? "Login" : "Sign Up";
      };

      // Toggle Forms
      elements.showSignUp.addEventListener("click", () => {
        elements.loginFormContainer.classList.add("hidden");
        elements.signUpFormContainer.classList.remove("hidden");
      });

      elements.showLogin.addEventListener("click", () => {
        elements.signUpFormContainer.classList.add("hidden");
        elements.loginFormContainer.classList.remove("hidden");
      });

      // Login Form Submission
      elements.loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        toggleButtonState(elements.loginSubmit, true);

        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          console.log("User logged in:", email);

          // Check user role
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            const role = userData.role || "member"; // Default to member
            window.location.href = role === "admin" ? "/admin-dashboard.html" : "/member-dashboard.html";
          } else {
            showError("User data not found. Please contact support.");
          }
        } catch (error) {
          showError(`Login failed: ${handleAuthError(error)}`);
          console.error("Login error:", error);
        } finally {
          toggleButtonState(elements.loginSubmit, false);
        }
      });

      // Sign Up Form Submission
      elements.signUpForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        toggleButtonState(elements.signUpSubmit, true);

        const name = elements.signUpName.value.trim();
        const email = elements.signUpEmail.value;
        const password = elements.signUpPassword.value;

        try {
          // Validate name
          if (!name) {
            showError("Please enter a valid full name.");
            return;
          }

          // Create Firebase Auth user
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          try {
            // Create Firestore user document
            await setDoc(doc(db, "users", user.uid), {
              name: name,
              email: email,
              status: "pending", // Matches member-dashboard.html
              role: "member", // Default role for new users
              shares: 0,
              balance: 0,
              approvalDate: null,
              lastDistribution: null,
            });

            console.log("User signed up:", email);
            window.location.href = "/member-dashboard.html";
          } catch (firestoreError) {
            // Rollback: Delete Firebase Auth user if Firestore fails
            await deleteUser(user);
            showError(`Failed to create user profile: ${firestoreError.message}`);
            console.error("Firestore error:", firestoreError);
          }
        } catch (error) {
          showError(`Sign up failed: ${handleAuthError(error)}`);
          console.error("Sign up error:", error);
        } finally {
          toggleButtonState(elements.signUpSubmit, false);
        }
      });

      // Redirect authenticated users to appropriate dashboard
      onAuthStateChanged(auth, async (user) => {
        if (user && window.location.pathname === "/index.html") {
          console.log("Authenticated user:", user.uid, user.email);
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              const role = userData.role || "member";
              window.location.href = role === "admin" ? "/admin-dashboard.html" : "/member-dashboard.html";
            } else {
              showError("User data not found. Please contact support.");
            }
          } catch (error) {
            showError(`Error checking user role: ${error.message}`);
            console.error("Role check error:", error);
          }
        }
      }, (error) => {
        console.error("Auth error:", error);
        showError(`Authentication error: ${handleAuthError(error)}`);
      });
    </script>
  </body>
</html>
