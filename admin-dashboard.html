<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ğŸ² Baccarat Fund Club - Admin</h1>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
  </header>

  <!-- Navigation Tabs -->
  <nav class="bg-gray-200 flex gap-4 p-4 text-sm font-medium">
    <button onclick="showTab('members')" class="tab-btn" id="tab-members">ğŸ‘¤ Members</button>
    <button onclick="showTab('requests')" class="tab-btn" id="tab-requests">ğŸ’¸ Cash Outs</button>
    <button onclick="showTab('profits')" class="tab-btn" id="tab-profits">ğŸ“ˆ Profits</button>
    <button onclick="showTab('settings')" class="tab-btn" id="tab-settings">âš™ï¸ Settings</button>
  </nav>

  <!-- Main Content -->
  <main class="p-4">
    <section id="members" class="tab-content">
      <h2 class="text-lg font-semibold mb-2">ğŸ‘¥ Member List</h2>
      <div id="memberList" class="space-y-2"></div>
    </section>

    <section id="requests" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">ğŸ’¸ Cash Out Requests</h2>
      <div id="requestList" class="space-y-2"></div>
    </section>

    <section id="profits" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">ğŸ“Š Distribute Profits</h2>
      <form id="profitForm" class="space-y-2">
        <input type="number" id="totalProfit" class="border p-2 w-full" placeholder="Enter total profit (PHP)" required />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Distribute</button>
      </form>
      <div id="profitLogs" class="mt-4 space-y-2 text-sm text-gray-700"></div>
    </section>

    <section id="settings" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">âš™ï¸ Settings</h2>
      <div class="space-y-2">
        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ“¥ Export CSV</button>
        <button onclick="cleanupOldPending()" class="bg-yellow-500 text-white px-4 py-2 rounded ml-2">ğŸ§¹ Clean Old Pending</button>
      </div>

      <h3 class="text-md font-semibold mt-4">ğŸ‘¤ Manage Members</h3>
      <div id="settingsMemberList" class="mt-2 space-y-2"></div>

      <h3 class="text-md font-semibold mt-6">ğŸ§¾ Admin Audit Logs</h3>
      <div id="adminLogList" class="text-sm text-gray-700 mt-2 space-y-1"></div>
    </section>
  </main>

  <!-- Edit Member Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">âœï¸ Edit Member</h3>
      <form id="editMemberForm" class="space-y-2">
        <input type="text" id="editName" class="border p-2 w-full" placeholder="Name" required />
        <input type="email" id="editEmail" class="border p-2 w-full" placeholder="Email" required />
        <input type="number" id="editShares" class="border p-2 w-full" placeholder="Shares" required />
        <input type="number" id="editBalance" class="border p-2 w-full" placeholder="Balance" required />
        <select id="editStatus" class="border p-2 w-full">
          <option value="active">Active</option>
          <option value="pending">Pending</option>
        </select>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="bg-gray-300 px-3 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-blue-500 text-white px-3 py-2 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
      collection, doc, getDocs, updateDoc, addDoc, deleteDoc,
      getDoc, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const logoutBtn = document.getElementById('logoutBtn');
    const memberList = document.getElementById('memberList');
    const requestList = document.getElementById('requestList');
    const profitForm = document.getElementById('profitForm');
    const profitLogs = document.getElementById('profitLogs');
    const settingsMemberList = document.getElementById('settingsMemberList');
    let currentEditId = null;

    function showTab(id) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('bg-white', 'border'));
      document.getElementById(`tab-${id}`).classList.add('bg-white', 'border', 'border-gray-400');
      if (id === 'settings') {
        loadSettingsMembers();
        loadAdminLogs();
      }
    }

    showTab('members');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Not logged in.");
        window.location.href = "index.html";
        return;
      }

      const adminRef = doc(db, "admins", user.uid);
      const adminSnap = await getDoc(adminRef);

      if (!adminSnap.exists()) {
        alert("Access denied.");
        window.location.href = "index.html";
        return;
      }

      loadMembers();
      loadRequests();
      loadProfits();
    });

    logoutBtn.onclick = () => signOut(auth).then(() => window.location.href = "index.html");

    async function loadMembers() {
      memberList.innerHTML = "";
      const snap = await getDocs(collection(db, "members"));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        memberList.innerHTML += `
          <div class="bg-white p-3 rounded shadow">
            <strong>${d.name || "Unnamed"}</strong> (${d.email})<br>
            Shares: ${d.shares || 0}, Balance: â‚±${d.balance || 0}<br>
            Status: ${d.status}
          </div>
        `;
      });
    }

    async function loadRequests() {
      requestList.innerHTML = "";
      const q = query(collection(db, "withdrawalRequests"), where("status", "==", "pending"));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        requestList.innerHTML += `
          <div class="bg-white p-3 rounded shadow">
            <strong>${d.memberName}</strong> requests â‚±${d.amount}<br>
            <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="approveRequest('${docSnap.id}')">Approve</button>
            <button class="bg-red-500 text-white px-2 py-1 rounded ml-2" onclick="rejectRequest('${docSnap.id}')">Reject</button>
          </div>
        `;
      });
    }

    window.approveRequest = async (id) => {
      await updateDoc(doc(db, "withdrawalRequests", id), { status: "approved" });
      loadRequests();
    };
    window.rejectRequest = async (id) => {
      await updateDoc(doc(db, "withdrawalRequests", id), { status: "rejected" });
      loadRequests();
    };

    profitForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const total = parseFloat(document.getElementById("totalProfit").value);
      const members = await getDocs(collection(db, "members"));
      const count = members.size;
      const perShare = total / count;

      for (const docSnap of members.docs) {
        const ref = doc(db, "members", docSnap.id);
        const data = docSnap.data();
        const bonus = (data.shares || 0) * perShare;
        await updateDoc(ref, {
          balance: (data.balance || 0) + bonus
        });
      }

      await addDoc(collection(db, "profitDistributions"), {
        amount: total,
        date: serverTimestamp()
      });

      profitLogs.innerHTML += `<div>Distributed â‚±${total} to ${count} members.</div>`;
      loadMembers();
    });

    async function loadProfits() {
      profitLogs.innerHTML = "";
      const snap = await getDocs(collection(db, "profitDistributions"));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        profitLogs.innerHTML += `<div>â‚±${d.amount} on ${new Date(d.date?.seconds * 1000).toLocaleString()}</div>`;
      });
    }

    window.exportToCSV = () => alert("ğŸ“¥ Exporting to CSV soon...");

    window.cleanupOldPending = async () => {
      const now = Date.now();
      const snap = await getDocs(collection(db, "members"));
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        const createdAt = data.createdAt?.seconds * 1000 || 0;
        if (data.status === 'pending' && now - createdAt > 7 * 24 * 60 * 60 * 1000) {
          await deleteDoc(doc(db, "members", docSnap.id));
        }
      }
      loadMembers();
    };

    async function logAdminAction(action, targetId, description) {
      const user = auth.currentUser;
      if (!user) return;
      await addDoc(collection(db, "adminLogs"), {
        adminUid: user.uid,
        action,
        targetId,
        description,
        timestamp: serverTimestamp()
      });
    }

    async function loadSettingsMembers() {
      settingsMemberList.innerHTML = "";
      const snap = await getDocs(collection(db, "members"));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        settingsMemberList.innerHTML += `
          <div class="bg-white p-3 rounded shadow flex justify-between items-center">
            <div>
              <strong>${d.name}</strong> (${d.email})<br>
              Shares: ${d.shares || 0}, Balance: â‚±${d.balance || 0}, Status: ${d.status}
            </div>
            <div class="space-x-2">
              <button onclick='editMember("${docSnap.id}", ${JSON.stringify(d).replace(/"/g, '&quot;')})' class="bg-blue-500 text-white px-2 py-1 rounded">Edit</button>
              <button onclick="deleteMember('${docSnap.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
            </div>
          </div>
        `;
      });
    }

    async function loadAdminLogs() {
      const logList = document.getElementById("adminLogList");
      logList.innerHTML = "";
      const q = query(collection(db, "adminLogs"), orderBy("timestamp", "desc"));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const time = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000).toLocaleString() : "Unknown time";
        logList.innerHTML += `<div>ğŸ“Œ ${d.action.toUpperCase()} by ${d.adminUid} â€” ${d.description} (${time})</div>`;
      });
    }

    window.editMember = (id, data) => {
      currentEditId = id;
      document.getElementById("editName").value = data.name || "";
      document.getElementById("editEmail").value = data.email || "";
      document.getElementById("editShares").value = data.shares || 0;
      document.getElementById("editBalance").value = data.balance || 0;
      document.getElementById("editStatus").value = data.status || "pending";
      document.getElementById("editModal").classList.remove("hidden");
    };

    window.closeEditModal = () => {
      document.getElementById("editModal").classList.add("hidden");
      currentEditId = null;
    };

    document.getElementById("editMemberForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const ref = doc(db, "members", currentEditId);
      await updateDoc(ref, {
        name: document.getElementById("editName").value,
        email: document.getElementById("editEmail").value,
        shares: parseFloat(document.getElementById("editShares").value),
        balance: parseFloat(document.getElementById("editBalance").value),
        status: document.getElementById("editStatus").value
      });
      await logAdminAction("edit", currentEditId, `Edited member ${document.getElementById("editName").value}`);
      closeEditModal();
      loadMembers();
      loadSettingsMembers();
    });

    window.deleteMember = async (id) => {
      if (confirm("Are you sure you want to delete this member?")) {
        await deleteDoc(doc(db, "members", id));
        await logAdminAction("delete", id, `Deleted member with ID ${id}`);
        loadMembers();
        loadSettingsMembers();
      }
    };
  </script>

</body>
</html>
