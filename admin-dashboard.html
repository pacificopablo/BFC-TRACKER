<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Baccarat Fund Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white p-4">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Baccarat Fund Admin Dashboard</h1>
        <div>
          <button id="syncSharesBtn" class="bg-purple-600 px-4 py-2 rounded">Sync Shares & Approval Dates</button>
          <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded ml-2">Logout</button>
          <button id="serverTimeBtn" class="bg-blue-600 px-4 py-2 rounded ml-2">Check Server Time</button>
        </div>
      </header>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-800 p-4 rounded shadow">
          <h2 class="text-lg font-semibold">Total Members</h2>
          <p id="totalMembers" class="text-2xl">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded shadow">
          <h2 class="text-lg font-semibold">Total Shares</h2>
          <p id="totalShares" class="text-2xl">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded shadow">
          <h2 class="text-lg font-semibold">Total Balance</h2>
          <p id="totalBalance" class="text-2xl">₱0.00</p>
        </div>
      </div>

      <!-- Financial Chart -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Fund Balance Overview</h2>
        <canvas id="fundChart"></canvas>
      </div>

      <!-- Distribute Profit/Loss -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Distribute Profit/Loss</h2>
        <form id="profitForm" class="flex flex-col sm:flex-row gap-4">
          <select id="transactionType" class="bg-gray-700 p-2 rounded">
            <option value="profit">Profit</option>
            <option value="loss">Loss</option>
          </select>
          <input
            id="profitAmount"
            type="number"
            step="0.01"
            min="0"
            placeholder="Amount (₱)"
            class="bg-gray-700 p-2 rounded"
          />
          <button
            id="distributeBtn"
            type="submit"
            class="bg-green-600 px-4 py-2 rounded hover:bg-green-700"
          >
            Distribute
          </button>
        </form>
        <p id="profitError" class="text-red-500 mt-2 hidden"></p>
        <p class="mt-2">Fund Balance: <span id="fundBalance">₱0.00</span></p>
      </div>

      <!-- Member Search -->
      <div class="mb-6">
        <input
          id="searchInput"
          type="text"
          placeholder="Search members by name, email, or status..."
          class="w-full bg-gray-700 p-2 rounded"
        />
      </div>

      <!-- Member List -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Member List</h2>
        <div id="membersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Top Shareholders -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Top Shareholders</h2>
        <ul id="topShareholders" class="list-disc pl-5"></ul>
      </div>

      <!-- Transaction Requests -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Transaction Requests</h2>
        <div id="requestsList"></div>
      </div>

      <!-- Daily Distribution Report -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Daily Distribution Report</h2>
        <div id="dailyReportList"></div>
      </div>

      <!-- Transaction History -->
      <div class="bg-gray-800 p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Transaction History</h2>
        <div class="flex gap-4 mb-4">
          <select id="historyFilter" class="bg-gray-700 p-2 rounded">
            <option value="all">All Transactions</option>
            <option value="profit">Profit Distributions</option>
            <option value="loss">Loss Deductions</option>
            <option value="deposit">Deposits</option>
            <option value="cashout">Cash Outs</option>
          </select>
          <select id="historySort" class="bg-gray-700 p-2 rounded">
            <option value="desc">Newest First</option>
            <option value="asc">Oldest First</option>
          </select>
        </div>
        <div id="historyList"></div>
      </div>

      <!-- Edit Member Modal -->
      <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded shadow w-full max-w-md">
          <h2 class="text-lg font-semibold mb-4">Edit Member</h2>
          <form id="editForm">
            <input type="hidden" id="editMemberId" />
            <div class="mb-4">
              <label class="block mb-1">Name</label>
              <input id="editName" type="text" class="w-full bg-gray-700 p-2 rounded" required />
            </div>
            <div class="mb-4">
              <label class="block mb-1">Email</label>
              <input id="editEmail" type="email" class="w-full bg-gray-700 p-2 rounded" required />
            </div>
            <div class="mb-4">
              <label class="block mb-1">Status</label>
              <select id="editStatus" class="w-full bg-gray-700 p-2 rounded">
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block mb-1">Balance (₱)</label>
              <input id="editBalance" type="number" step="0.01" min="0" class="w-full bg-gray-700 p-2 rounded" required />
            </div>
            <div class="mb-4">
              <label class="block mb-1">Approval Date</label>
              <input id="editApprovalDate" type="datetime-local" class="w-full bg-gray-700 p-2 rounded" />
            </div>
            <div class="mb-4">
              <label class="block mb-1">Last Distribution</label>
              <input id="editLastDistribution" type="datetime-local" class="w-full bg-gray-700 p-2 rounded" disabled />
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="cancelEdit" class="bg-gray-600 px-4 py-2 rounded">Cancel</button>
              <button type="submit" class="bg-blue-600 px-4 py-2 rounded">Save</button>
            </div>
          </form>
        </div>
      </div>

      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
          getFirestore,
          collection,
          getDocs,
          getDoc,
          doc,
          updateDoc,
          deleteDoc,
          query,
          where,
          orderBy,
          onSnapshot,
          writeBatch,
          setDoc,
          serverTimestamp,
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCN0dBQXoaWh_13lF0ON25otUpeH3OGINQ",
          authDomain: "bfc-tracker.firebaseapp.com",
          projectId: "bfc-tracker",
          storageBucket: "bfc-tracker.firebasestorage.app",
          messagingSenderId: "127052459580",
          appId: "1:127052459580:web:c3d5caa9302238c11cdd39",
          measurementId: "G-PNYRCFJHYM",
        };

        // Initialize Firebase
        let app, db, auth;
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          document.body.innerHTML = '<p class="text-red-500 p-4">Failed to initialize Firebase. Please check configuration.</p>';
          return;
        }

        // DOM Elements
        const elements = {
          totalMembers: document.getElementById("totalMembers"),
          totalShares: document.getElementById("totalShares"),
          totalBalance: document.getElementById("totalBalance"),
          membersList: document.getElementById("membersList"),
          topShareholders: document.getElementById("topShareholders"),
          searchInput: document.getElementById("searchInput"),
          requestsList: document.getElementById("requestsList"),
          historyList: document.getElementById("historyList"),
          historyFilter: document.getElementById("historyFilter"),
          historySort: document.getElementById("historySort"),
          dailyReportList: document.getElementById("dailyReportList"),
          editModal: document.getElementById("editModal"),
          editForm: document.getElementById("editForm"),
          editMemberId: document.getElementById("editMemberId"),
          editName: document.getElementById("editName"),
          editEmail: document.getElementById("editEmail"),
          editStatus: document.getElementById("editStatus"),
          editBalance: document.getElementById("editBalance"),
          editApprovalDate: document.getElementById("editApprovalDate"),
          editLastDistribution: document.getElementById("editLastDistribution"),
          cancelEdit: document.getElementById("cancelEdit"),
          logoutBtn: document.getElementById("logoutBtn"),
          serverTimeBtn: document.getElementById("serverTimeBtn"),
          syncSharesBtn: document.getElementById("syncSharesBtn"),
          profitForm: document.getElementById("profitForm"),
          profitAmount: document.getElementById("profitAmount"),
          distributeBtn: document.getElementById("distributeBtn"),
          profitError: document.getElementById("profitError"),
          fundBalance: document.getElementById("fundBalance"),
          transactionType: document.getElementById("transactionType"),
        };

        let allMembers = [];
        let allTransactions = [];
        let lastSubmissionTime = 0;
        const SUBMISSION_COOLDOWN = 5000; // 5 seconds
        const HOURS_THRESHOLD = 24; // 24-hour eligibility threshold
        const SHARES_PER_AMOUNT = 10; // 1 share per ₱10

        // Utility Functions
        const formatCurrency = (value) =>
          parseFloat(value || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 });

        const formatDate = (date) => {
          if (!date || isNaN(new Date(date).getTime())) return "None";
          return new Date(date).toLocaleString("en-PH");
        };

        const showError = (element, message) => {
          element.textContent = message;
          element.classList.remove("hidden");
          setTimeout(() => element.classList.add("hidden"), 5000);
        };

        const showLoading = (element, message = "Loading...") => {
          element.innerHTML = `<p class="text-gray-400">${message}</p>`;
        };

        const computeSharesFromBalance = (balance) => Math.floor((balance || 0) / SHARES_PER_AMOUNT);

        async function getServerTimeAsDate() {
          try {
            const tempRef = doc(collection(db, "temp"));
            await setDoc(tempRef, { timestamp: serverTimestamp() });
            const docSnap = await getDoc(tempRef);
            if (docSnap.exists()) {
              const serverTime = docSnap.data().timestamp.toDate();
              await deleteDoc(tempRef);
              return serverTime;
            }
            throw new Error("Failed to retrieve server time");
          } catch (error) {
            console.error("Error getting server time:", error);
            throw error;
          }
        }

        function getPHTDayRange(serverTime) {
          const phtTime = new Date(serverTime.getTime() + 8 * 60 * 60 * 1000);
          const startOfDay = new Date(phtTime);
          startOfDay.setHours(0, 0, 0, 0);
          const endOfDay = new Date(phtTime);
          endOfDay.setHours(23, 59, 59, 999);
          return {
            start: new Date(startOfDay.getTime() - 8 * 60 * 60 * 1000),
            end: new Date(endOfDay.getTime() - 8 * 60 * 60 * 1000),
          };
        }

        async function isMemberEligible(member, cachedServerTime = null) {
          if (member.status !== "approved") return { eligible: false, reason: "Not Approved" };
          if (!member.balance || member.balance <= 0) return { eligible: false, reason: "Zero/Negative Balance" };
          const approvalDate = member.approvalDate ? new Date(member.approvalDate) : null;
          if (!approvalDate || isNaN(approvalDate.getTime())) return { eligible: false, reason: "No Approval Date" };

          try {
            const now = cachedServerTime || (await getServerTimeAsDate());
            const hoursSinceApproval = (now - approvalDate) / (1000 * 60 * 60);
            if (hoursSinceApproval < HOURS_THRESHOLD) return { eligible: false, reason: "New Member (< 24 hrs)" };

            const lastDistribution = member.lastDistribution ? new Date(member.lastDistribution) : null;
            if (lastDistribution && !isNaN(lastDistribution.getTime())) {
              const { start } = getPHTDayRange(now);
              if (lastDistribution >= start) {
                return { eligible: false, reason: "Already Received Today" };
              }
            }

            return { eligible: true, reason: "Eligible" };
          } catch (error) {
            console.error("Error checking server time for eligibility:", error);
            return { eligible: false, reason: "Server Time Error" };
          }
        }

        function debounce(func, wait) {
          let timeout;
          return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }

        function listenForFundBalance() {
          const q = query(collection(db, "fund"));
          onSnapshot(
            q,
            (snapshot) => {
              if (snapshot.empty) {
                setDoc(doc(db, "fund", "main"), { balance: 0 });
                elements.fundBalance.textContent = formatCurrency(0);
                return;
              }
              if (snapshot.docs.length > 1) {
                console.warn("Multiple fund documents detected:", snapshot.docs.map((d) => d.id));
              }
              const fundDoc = snapshot.docs[0];
              const balance = fundDoc.data().balance || 0;
              elements.fundBalance.textContent = formatCurrency(balance);
            },
            (error) => {
              console.error("Error loading fund balance:", error);
              showError(elements.profitError, `Nabigo sa pag-load ng fund balance: ${error.message}`);
              elements.fundBalance.textContent = formatCurrency(0);
            }
          );
        }

        async function loadDailyReport() {
          showLoading(elements.dailyReportList, "Naglo-load ng daily report...");
          try {
            const now = await getServerTimeAsDate();
            const { start, end } = getPHTDayRange(now);
            const q = query(
              collection(db, "member_distributions"),
              where("timestamp", ">=", start),
              where("timestamp", "<=", end),
              orderBy("timestamp", "desc")
            );
            const snapshot = await getDocs(q);
            elements.dailyReportList.innerHTML = "";
            if (snapshot.empty) {
              elements.dailyReportList.innerHTML = '<p class="text-gray-400">Walang distribusyon ngayong araw.</p>';
              return;
            }

            snapshot.docs.forEach((doc) => {
              try {
                const data = doc.data();
                let sharesText = "";
                if (data.sharesAdded > 0) {
                  sharesText = `, Shares Added: ${data.sharesAdded}`;
                } else if (data.sharesAdded < 0) {
                  sharesText = `, Shares Deducted: ${Math.abs(data.sharesAdded)}`;
                }
                const div = document.createElement("div");
                div.className = "bg-gray-700 p-4 rounded";
                div.innerHTML = `
                  <p><strong>Miyembro:</strong> ${data.memberName || "N/A"}</p>
                  <p><strong>Uri:</strong> ${data.type === "profit" ? "Profit" : "Loss"}</p>
                  <p><strong>Halaga:</strong> ${data.type === "profit" ? "+" : "-"}₱${formatCurrency(data.amount)}${sharesText}</p>
                  <p><strong>Petsa:</strong> ${data.timestamp?.toDate().toLocaleString("en-PH") || "N/A"}</p>
                `;
                elements.dailyReportList.appendChild(div);
              } catch (error) {
                console.error(`Error rendering distribution ${doc.id}:`, error);
              }
            });
          } catch (error) {
            console.error("Error loading daily report:", error);
            showError(elements.profitError, `Nabigo sa pag-load ng daily report: ${error.message}`);
            elements.dailyReportList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng daily report.</p>';
          }
        }

        async function syncSharesAndApprovalDates() {
          if (!allMembers.length) {
            showError(elements.profitError, "Walang mga miyembro na nahanap para i-sync.");
            return;
          }
          try {
            const batch = writeBatch(db);
            const now = await getServerTimeAsDate();
            const nowISO = now.toISOString();
            let updatedCount = 0;

            for (const member of allMembers) {
              const newShares = computeSharesFromBalance(member.balance);
              const userRef = doc(db, "users", member.id);
              const updateData = { shares: newShares };
              if (member.status === "approved" && !member.approvalDate) {
                updateData.approvalDate = nowISO;
              }
              if (member.lastDistribution && isNaN(new Date(member.lastDistribution).getTime())) {
                updateData.lastDistribution = null;
              }
              batch.update(userRef, updateData);
              updatedCount++;
              console.log(
                `Synced shares for ${member.name || "N/A"}: ${newShares}, Approval Date: ${
                  updateData.approvalDate || member.approvalDate || "N/A"
                }, Last Distribution: ${updateData.lastDistribution || member.lastDistribution || "N/A"}`
              );
            }
            await batch.commit();
            console.log(`Successfully synced ${updatedCount} members`);
            await loadDailyReport();
            alert("Matagumpay na na-sync ang shares at approval dates para sa lahat ng miyembro!");
          } catch (error) {
            console.error("Error syncing shares and approval dates:", error);
            showError(elements.profitError, `Nabigo sa pag-sync ng shares at approval dates: ${error.message}`);
          }
        }

        let isInitialized = false;
        onAuthStateChanged(auth, (user) => {
          if (!user) {
            showError(elements.profitError, "Hindi ka authenticated. Ire-redirect sa login...");
            setTimeout(() => (window.location.href = "/login.html"), 2000);
          } else if (!isInitialized) {
            isInitialized = true;
            listenForFundBalance();
            listenForMembers();
            listenForRequests();
            listenForTransactionHistory();
            loadDailyReport();
            initializeChart();
          }
        });

        function listenForMembers() {
          console.log("listenForMembers called");
          showLoading(elements.membersList, "Naglo-load ng mga miyembro...");
          showLoading(elements.topShareholders, "Naglo-load ng mga shareholder...");
          elements.totalMembers.textContent = "Naglo-load...";
          elements.totalShares.textContent = "Naglo-load...";
          elements.totalBalance.textContent = "Naglo-load...";

          const q = query(collection(db, "users"));
          onSnapshot(
            q,
            (snapshot) => {
              allMembers = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              console.log("Fetched members:", allMembers);
              const uniqueIds = new Set(allMembers.map((m) => m.id));
              if (uniqueIds.size !== allMembers.length) {
                console.warn("Duplicate member IDs detected:", allMembers);
              }
              if (allMembers.length === 0) {
                elements.membersList.innerHTML = '<p class="text-gray-400">Walang nahanap na miyembro.</p>';
                elements.topShareholders.innerHTML = '<p class="text-gray-400">Walang shareholders.</p>';
                elements.totalMembers.textContent = "0";
                elements.totalShares.textContent = "0";
                elements.totalBalance.textContent = formatCurrency(0);
              } else {
                displayMembers(allMembers);
                updateTopShareholders();
              }
            },
            (error) => {
              console.error("Error in members listener:", error);
              showError(elements.profitError, `Nabigo sa pag-load ng mga miyembro: ${error.message}`);
              elements.membersList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng mga miyembro.</p>';
              elements.totalMembers.textContent = "0";
              elements.totalShares.textContent = "0";
              elements.totalBalance.textContent = formatCurrency(0);
            }
          );
        }

        async function displayMembers(members) {
          console.log("displayMembers called with", members.length, "members");
          let memberCount = 0,
              shareTotal = 0,
              balanceTotal = 0;
          elements.membersList.innerHTML = "";
          const renderedIds = new Set();
          const now = await getServerTimeAsDate();

          for (const m of members) {
            if (!m.id || renderedIds.has(m.id)) {
              console.warn(`Skipping invalid or duplicate member ID: ${m.id}`);
              continue;
            }
            renderedIds.add(m.id);
            memberCount++;
            shareTotal += m.shares || 0;
            balanceTotal += m.balance || 0;

            const eligibility = await isMemberEligible(m, now);
            const lastDistributionText = formatDate(m.lastDistribution);
            const approvalDateText = formatDate(m.approvalDate);

            const div = document.createElement("div");
            div.className = "bg-gray-800 p-4 rounded shadow";
            div.dataset.memberId = m.id;
            div.innerHTML = `
              <p><strong>Pangalan:</strong> ${m.name || "N/A"}</p>
              <p><strong>Email:</strong> ${m.email || "N/A"}</p>
              <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
                m.status === "approved"
                  ? "bg-green-600"
                  : m.status === "pending"
                  ? "bg-yellow-600"
                  : "bg-red-600"
              }">${m.status || "N/A"}</span></p>
              <p><strong>Shares:</strong> ${m.shares || 0}</p>
              <p><strong>Balance:</strong> ₱${formatCurrency(m.balance)}</p>
              <p><strong>Approval Date:</strong> ${approvalDateText}</p>
              <p><strong>Eligible for Profit/Loss:</strong> ${
                eligibility.eligible ? "Yes" : `No (${eligibility.reason})`
              }</p>
              <p><strong>Last Distribution:</strong> ${lastDistributionText}</p>
              <div class="flex space-x-2 mt-2">
                <button data-id="${m.id}" class="edit-btn bg-blue-600 px-3 py-1 rounded text-sm">I-edit</button>
                <button data-id="${m.id}" data-name="${
                  m.name || "Unknown"
                }" class="delete-btn bg-red-600 px-3 py-1 rounded text-sm">I-delete</button>
              </div>
            `;
            elements.membersList.appendChild(div);
          }

          elements.totalMembers.textContent = memberCount;
          elements.totalShares.textContent = shareTotal;
          elements.totalBalance.textContent = formatCurrency(balanceTotal);
        }

        async function updateTopShareholders() {
          const top = [];
          const now = await getServerTimeAsDate();
          for (const m of allMembers) {
            const eligibility = await isMemberEligible(m, now);
            if (m.status === "approved" && eligibility.eligible) {
              top.push(m);
            }
          }
          top.sort((a, b) => (b.shares || 0) - (a.shares || 0)).slice(0, 5);

          elements.topShareholders.innerHTML = "";
          if (top.length === 0) {
            elements.topShareholders.innerHTML = '<p class="text-gray-400">Walang eligible na shareholders.</p>';
          } else {
            top.forEach((m) => {
              const li = document.createElement("li");
              li.textContent = `${m.name || "N/A"} — ${m.shares || 0} shares`;
              elements.topShareholders.appendChild(li);
            });
          }
        }

        elements.searchInput.addEventListener(
          "input",
          debounce(async () => {
            const query = elements.searchInput.value.toLowerCase();
            const filtered = allMembers.filter(
              (m) =>
                (m.name || "").toLowerCase().includes(query) ||
                (m.email || "").toLowerCase().includes(query) ||
                (m.status || "").toLowerCase().includes(query)
            );
            await displayMembers(filtered);
          }, 300)
        );

        function listenForRequests() {
          showLoading(elements.requestsList, "Naglo-load ng mga kahilingan...");
          const q = query(collection(db, "transactions"), orderBy("timestamp", "desc"));
          onSnapshot(
            q,
            (snapshot) => {
              elements.requestsList.innerHTML = "";
              const pendingRequests = snapshot.docs.filter((doc) => doc.data().status === "pending");
              if (pendingRequests.length === 0) {
                elements.requestsList.innerHTML = '<p class="text-gray-400">Walang pending na kahilingan.</p>';
              } else {
                pendingRequests.forEach((docSnap) => {
                  const data = docSnap.data();
                  const div = document.createElement("div");
                  div.className = "bg-gray-700 p-4 rounded";
                  div.innerHTML = `
                    <p><strong>Miyembro:</strong> ${data.memberName || "N/A"}</p>
                    <p><strong>Uri:</strong> ${data.type || "N/A"}</p>
                    <p><strong>Halaga:</strong> ₱${formatCurrency(data.amount)}</p>
                    <p><strong>Petsa:</strong> ${
                      data.timestamp?.toDate().toLocaleString() || "N/A"
                    }</p>
                    <div class="flex space-x-2 mt-2">
                      <button data-id="${docSnap.id}" class="approve-btn bg-green-600 px-3 py-1 rounded text-sm">Approve</button>
                      <button data-id="${docSnap.id}" class="reject-btn bg-red-600 px-3 py-1 rounded text-sm">Reject</button>
                    </div>
                  `;
                  elements.requestsList.appendChild(div);
                });
              }
            },
            (error) => {
              console.error("Error sa pag-load ng mga kahilingan:", error);
              showError(elements.profitError, `Nabigo sa pag-load ng mga kahilingan: ${error.message}`);
              elements.requestsList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng mga kahilingan.</p>';
            }
          );
        }

        function listenForTransactionHistory() {
          showLoading(elements.historyList, "Naglo-load ng kasaysayan ng transaksyon...");
          const profitQuery = query(collection(db, "profit_distributions"), orderBy("timestamp", "desc"));
          const transactionQuery = query(collection(db, "transactions"), orderBy("timestamp", "desc"));

          const updateTransactions = () => {
            allTransactions = [];

            const addProfitDistributions = (snapshot) => {
              snapshot.docs.forEach((doc) => {
                const data = doc.data();
                allTransactions.push({
                  id: doc.id,
                  type: data.type === "profit" ? "Profit Distribution" : "Loss Deduction",
                  filterType: data.type,
                  amount: data.amount,
                  timestamp: data.timestamp?.toDate() || new Date(),
                  details: `Distributed to ${data.eligibleMemberCount} of ${data.totalMemberCount} members, Total Shares: ${data.totalShares}`,
                });
              });
            };

            const addTransactions = (snapshot) => {
              snapshot.docs.forEach((doc) => {
                const data = doc.data();
                allTransactions.push({
                  id: doc.id,
                  type: data.type === "deposit" ? "Deposit" : "Cash Out",
                  filterType: data.type === "deposit" ? "deposit" : "cashout",
                  amount: data.amount,
                  timestamp: data.timestamp?.toDate() || new Date(),
                  details: `Member: ${data.memberName || "N/A"}, Status: ${data.status
