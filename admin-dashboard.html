<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Baccarat Fund Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white p-4">
    <!-- Header with Logout Button -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üëë Baccarat Fund Admin Dashboard</h1>
      <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded text-sm hover:bg-red-700">Logout</button>
    </div>
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm">Total Members</p>
        <p class="text-2xl font-bold" id="totalMembers">Loading...</p>
      </div>
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm">Total Shares</p>
        <p class="text-2xl font-bold" id="totalShares">Loading...</p>
      </div>
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm">Total Balance</p>
        <p class="text-2xl font-bold">‚Ç±<span id="totalBalance">Loading...</span></p>
      </div>
    </div>
    <!-- Financial Chart -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-2">üìä Fund Growth</h2>
      <canvas id="fundChart" height="100"></canvas>
    </div>
    <!-- Distribute Profit/Loss Section -->
    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <h2 class="text-xl font-bold mb-4">üí∏ Distribute Profit or Loss</h2>
      <p class="text-sm mb-2">Current Fund Balance: ‚Ç±<span id="fundBalance">Loading...</span></p>
      <form id="profitForm" class="flex flex-col space-y-4">
        <div>
          <label class="block text-sm mb-1">Transaction Type</label>
          <select id="transactionType" class="w-full p-2 rounded bg-gray-700 text-white" required>
            <option value="profit">Profit (Panalo)</option>
            <option value="loss">Loss (Pagkatalo)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Amount (‚Ç±)</label>
          <input
            type="number"
            id="profitAmount"
            class="w-full p-2 rounded bg-gray-700 text-white"
            placeholder="Enter amount"
            required
            min="0"
            step="0.01"
          />
        </div>
        <button
          type="submit"
          id="distributeBtn"
          class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
        >
          Submit Transaction
        </button>
      </form>
      <p id="profitError" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>
    <!-- Member Search -->
    <input
      type="text"
      id="searchInput"
      placeholder="Search by name, email, or status..."
      class="mb-4 p-2 w-full rounded bg-gray-700 text-white"
    />
    <!-- Member List -->
    <div id="membersList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">Loading members...</div>
    <!-- Top 5 Shareholders -->
    <div class="bg-gray-800 p-4 mt-8 rounded shadow">
      <h2 class="text-xl font-bold mb-2">üèÜ Top 5 Shareholders</h2>
      <ul id="topShareholders" class="list-disc list-inside text-sm">Loading...</ul>
    </div>
    <!-- Transaction Requests -->
    <h2 class="text-2xl font-bold mt-10 mb-4">üí∞ Deposit & Cash Out Requests</h2>
    <div id="requestsList" class="space-y-4 max-h-96 overflow-auto bg-gray-800 p-4 rounded">
      Loading requests...
    </div>
    <!-- Edit Member Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center">
      <div class="bg-gray-800 p-6 rounded shadow w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Edit Member</h2>
        <form id="editForm">
          <input type="hidden" id="editMemberId" />
          <div class="mb-4">
            <label class="block text-sm">Name</label>
            <input type="text" id="editName" class="w-full p-2 rounded bg-gray-700 text-white" required />
          </div>
          <div class="mb-4">
            <label class="block text-sm">Email</label>
            <input type="email" id="editEmail" class="w-full p-2 rounded bg-gray-700 text-white" required />
          </div>
          <div class="mb-4">
            <label class="block text-sm">Status</label>
            <select id="editStatus" class="w-full p-2 rounded bg-gray-700 text-white" required>
              <option value="approved">Approved</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm">Shares</label>
            <input type="number" id="editShares" class="w-full p-2 rounded bg-gray-700 text-white" required min="0" />
          </div>
          <div class="mb-4">
            <label class="block text-sm">Balance</label>
            <input
              type="number"
              id="editBalance"
              class="w-full p-2 rounded bg-gray-700 text-white"
              required
              min="0"
              step="0.01"
            />
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelEdit" class="bg-gray-600 px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-blue-600 px-4 py-2 rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
    <script type="module">
      // Import Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        onSnapshot,
        writeBatch,
        setDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCN0dBQXoaWh_13lF0ON25otUpeH3OGINQ",
        authDomain: "bfc-tracker.firebaseapp.com",
        projectId: "bfc-tracker",
        storageBucket: "bfc-tracker.firebasestorage.app",
        messagingSenderId: "127052459580",
        appId: "1:127052459580:web:c3d5caa9302238c11cdd39",
        measurementId: "G-PNYRCFJHYM"
      };

      // Initialize Firebase
      let app, db, auth;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
      } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = '<p class="text-red-500 p-4">Failed to initialize Firebase. Please check configuration.</p>';
      }

      // DOM Elements
      const elements = {
        totalMembers: document.getElementById("totalMembers"),
        totalShares: document.getElementById("totalShares"),
        totalBalance: document.getElementById("totalBalance"),
        membersList: document.getElementById("membersList"),
        topShareholders: document.getElementById("topShareholders"),
        searchInput: document.getElementById("searchInput"),
        requestsList: document.getElementById("requestsList"),
        editModal: document.getElementById("editModal"),
        editForm: document.getElementById("editForm"),
        editMemberId: document.getElementById("editMemberId"),
        editName: document.getElementById("editName"),
        editEmail: document.getElementById("editEmail"),
        editStatus: document.getElementById("editStatus"),
        editShares: document.getElementById("editShares"),
        editBalance: document.getElementById("editBalance"),
        cancelEdit: document.getElementById("cancelEdit"),
        logoutBtn: document.getElementById("logoutBtn"),
        profitForm: document.getElementById("profitForm"),
        profitAmount: document.getElementById("profitAmount"),
        distributeBtn: document.getElementById("distributeBtn"),
        profitError: document.getElementById("profitError"),
        fundBalance: document.getElementById("fundBalance"),
        transactionType: document.getElementById("transactionType"),
      };

      let allMembers = [];
      let lastSubmissionTime = 0;
      const SUBMISSION_COOLDOWN = 5000; // 5 seconds

      // Utility Functions
      const formatCurrency = (value) =>
        parseFloat(value || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (element, message) => {
        element.textContent = message;
        element.classList.remove("hidden");
        setTimeout(() => element.classList.add("hidden"), 5000);
      };

      const showLoading = (element, message = "Loading...") => {
        element.innerHTML = `<p class="text-gray-400">${message}</p>`;
      };

      // Load Fund Balance (Sum of Members' Balances)
      async function loadFundBalance() {
        try {
          const snapshot = await getDocs(collection(db, "users"));
          allMembers = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          const totalBalance = allMembers.reduce((sum, m) => sum + (m.balance || 0), 0);

          const fundSnapshot = await getDocs(collection(db, "fund"));
          if (fundSnapshot.empty) {
            await setDoc(doc(db, "fund", "main"), { balance: totalBalance });
          } else {
            const fundRef = doc(db, "fund", fundSnapshot.docs[0].id);
            await updateDoc(fundRef, { balance: totalBalance });
          }

          elements.fundBalance.textContent = formatCurrency(totalBalance);
          return totalBalance;
        } catch (error) {
          console.error("Error loading fund balance:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng fund balance: ${error.message}`);
          return 0;
        }
      }

      // Authentication Check
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          showError(elements.profitError, "Hindi ka authenticated. Ire-redirect sa login...");
          setTimeout(() => (window.location.href = "/new-login.html"), 2000);
        } else {
          loadFundBalance().then(() => {
            loadMembers();
            listenForRequests();
            listenForMemberChanges();
          });
        }
      });

      // Listen for Member Changes (Real-Time)
      function listenForMemberChanges() {
        onSnapshot(collection(db, "users"), (snapshot) => {
          allMembers = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          displayMembers(allMembers);
          loadFundBalance();
        }, (error) => {
          console.error("Error listening for member changes:", error);
          showError(elements.profitError, `Nabigo sa pag-monitor ng mga miyembro: ${error.message}`);
        });
      }

      // Load Members
      async function loadMembers() {
        showLoading(elements.membersList, "Naglo-load ng mga miyembro...");
        showLoading(elements.topShareholders, "Naglo-load ng mga shareholder...");
        elements.totalMembers.textContent = "Naglo-load...";
        elements.totalShares.textContent = "Naglo-load...";
        elements.totalBalance.textContent = "Naglo-load...";

        try {
          displayMembers(allMembers);
          updateTopShareholders();
        } catch (error) {
          console.error("Error sa pag-load ng mga miyembro:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng mga miyembro: ${error.message}`);
          elements.membersList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng mga miyembro.</p>';
          elements.totalMembers.textContent = "0";
          elements.totalShares.textContent = "0";
          elements.totalBalance.textContent = formatCurrency(0);
        }
      }

      // Display Members
      function displayMembers(members) {
        let memberCount = 0,
          shareTotal = 0,
          balanceTotal = 0;
        elements.membersList.innerHTML = "";

        members.forEach((m) => {
          memberCount++;
          shareTotal += m.shares || 0;
          balanceTotal += m.balance || 0;

          const div = document.createElement("div");
          div.className = "bg-gray-800 p-4 rounded shadow";
          div.innerHTML = `
            <p><strong>Pangalan:</strong> ${m.name || "N/A"}</p>
            <p><strong>Email:</strong> ${m.email || "N/A"}</p>
            <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
              m.status === "approved"
                ? "bg-green-600"
                : m.status === "pending"
                ? "bg-yellow-600"
                : "bg-red-600"
            }">${m.status || "N/A"}</span></p>
            <p><strong>Shares:</strong> ${m.shares || 0}</p>
            <p><strong>Balance:</strong> ‚Ç±${formatCurrency(m.balance)}</p>
            <div class="flex space-x-2 mt-2">
              <button data-id="${m.id}" class="edit-btn bg-blue-600 px-3 py-1 rounded text-sm">I-edit</button>
              <button data-id="${m.id}" data-name="${
                m.name || "Unknown"
              }" class="delete-btn bg-red-600 px-3 py-1 rounded text-sm">I-delete</button>
            </div>
          `;
          elements.membersList.appendChild(div);
        });

        elements.totalMembers.textContent = memberCount;
        elements.totalShares.textContent = shareTotal;
        elements.totalBalance.textContent = formatCurrency(balanceTotal);
        elements.f focuses on the logout redirect, I‚Äôll keep the fund balance logic as previously modified (fund balance = sum of members‚Äô balances) and update only the logout redirect.

### Key Change
- Updated the logout redirect from `/login.html` to `/new-login.html` in two places:
  1. **Logout Button Click**:
     ```javascript
     window.location.href = "/new-login.html";
     ```
  2. **Authentication Check** (if user is not authenticated):
     ```javascript
     setTimeout(() => (window.location.href = "/new-login.html"), 2000);
     ```

### Notes
- **Redirect URL**: I used `/new-login.html` as a placeholder. Please replace it with the actual URL (e.g., `/index.html`, `/home.html`, or your specific login page path) if different.
- **Fund Balance**: The fund balance logic remains as the sum of all members‚Äô `balance` fields, with real-time updates via `onSnapshot` and validation to prevent negative balances during loss distributions.
- **Security**: Ensure Firebase security rules restrict access to the `fund` and `users` collections to authorized admins. For example:
  ```javascript
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /fund/{document=**} {
        allow read, write: if request.auth != null && request.auth.token.admin == true;
      }
      match /users/{document=**} {
        allow read, write: if request.auth != null && request.auth.token.admin == true;
      }
    }
  }
