<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Club - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <!-- Header -->
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">üé≤ Baccarat Fund Club - Admin</h1>
    <button class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  </header>

  <!-- Tab Buttons -->
  <div id="tabButtons" class="flex space-x-4 text-sm font-semibold mb-6">
    <button onclick="showTab('members', this)" class="tab-btn px-3 py-1 rounded">üë§ Members</button>
    <button onclick="showTab('requests', this)" class="tab-btn px-3 py-1 rounded">üí∏ Cash Outs</button>
    <button onclick="showTab('profits', this)" class="tab-btn px-3 py-1 rounded">üìà Profits</button>
    <button onclick="showTab('settings', this)" class="tab-btn px-3 py-1 rounded">‚öôÔ∏è Settings</button>
  </div>

  <!-- üë§ Members Tab -->
  <section id="members" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">üë§ Members</h2>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-gray-800">
          <th class="p-2">Name</th>
          <th class="p-2">Email</th>
          <th class="p-2">Shares</th>
          <th class="p-2">Balance (‚Ç±)</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="memberList">
        <!-- Member data will be dynamically inserted here -->
      </tbody>
    </table>
  </section>

  <!-- üí∏ Cash Outs Tab -->
  <section id="requests" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">üí∏ Cash Out Requests</h2>
    <div class="mb-4">
      <button onclick="refreshCashOutRequests()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üîÑ Refresh Requests</button>
    </div>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-gray-800">
          <th class="p-2">Member Name</th>
          <th class="p-2">Email</th>
          <th class="p-2">Amount (‚Ç±)</th>
          <th class="p-2">Shares</th>
          <th class="p-2">Status</th>
          <th class="p-2">Requested At</th>
          <th class="p-2">Processed At</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="requestList">
        <!-- Cash out request data will be dynamically inserted here -->
      </tbody>
    </table>
  </section>

  <!-- üìà Profits Tab -->
  <section id="profits" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">üìà Profits</h2>
    <p>Profit distribution section goes here...</p>
  </section>

  <!-- ‚öôÔ∏è Settings Tab -->
  <section id="settings" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">‚öôÔ∏è Settings</h2>
    <div class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">üîÑ Conversion Rate (‚Ç± per share):</label>
        <input type="number" id="conversionRateInput" class="border p-2 w-full text-black" min="1" step="1" />
        <button onclick="updateConversionRate()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üíæ Save Rate</button>
      </div>
      <div>
        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì• Export CSV</button>
        <button onclick="cleanupOldPending()" class="bg-yellow-500 text-white px-4 py-2 rounded ml-2 hover:bg-yellow-600">üßπ Clean Old Pending</button>
      </div>
    </div>
  </section>

  <!-- Firebase and Logic -->
  <script type="module">
    import { db } from './firebase-config.js';
    import { 
      doc, getDoc, updateDoc, collection, getDocs, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    let conversionRate = 10;

    // Load conversion rate from Firestore
    async function loadConversionRate() {
      const docRef = doc(db, "settings", "conversion");
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        conversionRate = snap.data().rate || 10;
        document.getElementById("conversionRateInput").value = conversionRate;
      }
    }

    // Update conversion rate
    window.updateConversionRate = async () => {
      const newRate = parseFloat(document.getElementById("conversionRateInput").value);
      if (isNaN(newRate) || newRate <= 0) return alert("Please enter a valid rate.");

      try {
        await updateDoc(doc(db, "settings", "conversion"), { rate: newRate });
        conversionRate = newRate;
        alert(`‚úÖ Conversion rate updated to ‚Ç±${newRate} per share.`);
        updateBalanceDisplays();
        await loadMembers(); // Reload members to update balances
        await loadCashOutRequests(); // Reload cash out requests to update shares
      } catch (error) {
        console.error("Error updating conversion rate:", error);
        alert("Failed to update conversion rate.");
      }
    };

    // Load members from Firestore
    async function loadMembers() {
      const memberList = document.getElementById("memberList");
      memberList.innerHTML = '<tr><td colspan="5" class="p-2 text-center">Loading...</td></tr>';

      try {
        const querySnapshot = await getDocs(collection(db, "members"));
        memberList.innerHTML = ""; // Clear loading message
        if (querySnapshot.empty) {
          memberList.innerHTML = '<tr><td colspan="5" class="p-2 text-center">No members found.</td></tr>';
          return;
        }
        querySnapshot.forEach((doc) => {
          const member = doc.data();
          const balance = (member.shares || 0) * conversionRate;
          const row = `
            <tr class="border-b border-gray-700">
              <td class="p-2">${member.name || "N/A"}</td>
              <td class="p-2">${member.email || "N/A"}</td>
              <td class="p-2">${member.shares || 0}</td>
              <td class="p-2">${balance.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
              <td class="p-2">
                <button onclick="editMember('${doc.id}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Edit</button>
                <button onclick="deleteMember('${doc.id}')" class="bg-red-600 text-white px-2 py-1 rounded ml-1 hover:bg-red-700">Delete</button>
              </td>
            </tr>
          `;
          memberList.innerHTML += row;
        });
      } catch (error) {
        console.error("Error loading members:", error);
        memberList.innerHTML = '<tr><td colspan="5" class="p-2 text-center text-red-500">Failed to load members. Please try again.</td></tr>';
      }
    }

    // Load cash out requests from Firestore
    async function loadCashOutRequests() {
      const requestList = document.getElementById("requestList");
      requestList.innerHTML = '<tr><td colspan="8" class="p-2 text-center">Loading...</td></tr>';

      try {
        const querySnapshot = await getDocs(collection(db, "cashouts"));
        requestList.innerHTML = ""; // Clear loading message
        if (querySnapshot.empty) {
          requestList.innerHTML = '<tr><td colspan="8" class="p-2 text-center">No cash out requests found.</td></tr>';
          return;
        }

        for (const doc of querySnapshot.docs) {
          const request = doc.data();
          // Fetch member details
          const memberRef = doc(db, "members", request.memberId);
          const memberSnap = await getDoc(memberRef);
          const member = memberSnap.exists() ? memberSnap.data() : { name: "Unknown", email: "N/A", shares: 0 };

          const shares = Math.ceil(request.amount / conversionRate); // Calculate shares
          const requestedAt = request.requestedAt?.toDate ? request.requestedAt.toDate().toLocaleString() : "N/A";
          const processedAt = request.processedAt?.toDate ? request.processedAt.toDate().toLocaleString() : "N/A";
          const row = `
            <tr class="border-b border-gray-700">
              <td class="p-2">${member.name || "N/A"}</td>
              <td class="p-2">${member.email || "N/A"}</td>
              <td class="p-2">${request.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
              <td class="p-2">${shares}</td>
              <td class="p-2">${request.status || "Pending"}</td>
              <td class="p-2">${requestedAt}</td>
              <td class="p-2">${processedAt}</td>
              <td class="p-2">
                ${request.status === "Pending" ? `
                  <button onclick="processCashOut('${doc.id}', 'Approved', ${request.amount}, ${shares}, '${memberSnap.id}', ${member.shares})" 
                          class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Approve</button>
                  <button onclick="processCashOut('${doc.id}', 'Rejected', ${request.amount}, ${shares}, '${memberSnap.id}', ${member.shares})" 
                          class="bg-red-600 text-white px-2 py-1 rounded ml-1 hover:bg-red-700">Reject</button>
                ` : `<span class="text-gray-500">${request.status}</span>`}
              </td>
            </tr>
          `;
          requestList.innerHTML += row;
        }
      } catch (error) {
        console.error("Error loading cash out requests:", error);
        requestList.innerHTML = '<tr><td colspan="8" class="p-2 text-center text-red-500">Failed to load requests. Please try again.</td></tr>';
      }
    }

    // Process cash out request (Approve or Reject)
    window.processCashOut = async (requestId, status, amount, shares, memberId, currentShares) => {
      const action = status.toLowerCase();
      if (!confirm(`Are you sure you want to ${action} this cash out request for ‚Ç±${amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}?`)) return;

      try {
        const requestRef = doc(db, "cashouts", requestId);
        const requestSnap = await getDoc(requestRef);
        if (!requestSnap.exists()) {
          alert("Cash out request not found.");
          return;
        }

        if (requestSnap.data().status !== "Pending") {
          alert("This request has already been processed.");
          await loadCashOutRequests();
          return;
        }

        // Validate shares for approval
        if (status === "Approved" && shares > currentShares) {
          alert(`Cannot approve: Member has only ${currentShares} shares, but ${shares} shares are required.`);
          return;
        }

        // Update request status
        await updateDoc(requestRef, {
          status,
          processedAt: new Date()
        });

        // If approved, deduct shares from member
        if (status === "Approved") {
          const memberRef = doc(db, "members", memberId);
          const newShares = Math.max(0, currentShares - shares);
          await updateDoc(memberRef, { shares: newShares });
        }

        alert(`Cash out request ${action} successfully.`);
        await loadCashOutRequests(); // Reload cash out requests
        await loadMembers(); // Reload members to reflect updated shares
      } catch (error) {
        console.error(`Error processing cash out (${status}):`, error);
        alert(`Failed to ${action} cash out request. Please check the console for details.`);
      }
    };

    // Refresh cash out requests
    window.refreshCashOutRequests = async () => {
      await loadCashOutRequests();
      alert("Cash out requests refreshed.");
    };

    // Update balance displays (for add/edit shares inputs, if they exist)
    function updateBalanceDisplays() {
      const addShares = parseInt(document.getElementById('addShares')?.value) || 0;
      const editShares = parseInt(document.getElementById('editShares')?.value) || 0;
      document.getElementById('addBalanceDisplay')?.textContent = (addShares * conversionRate).toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('editBalanceDisplay')?.textContent = (editShares * conversionRate).toLocaleString(undefined, { minimumFractionDigits: 2 });
    }

    // Edit member (placeholder)
    window.editMember = (memberId) => {
      alert(`Edit member with ID: ${memberId}`);
      // Implement a modal or form to edit member details
    };

    // Delete member
    window.deleteMember = async (memberId) => {
      if (confirm("Are you sure you want to delete this member?")) {
        try {
          await deleteDoc(doc(db, "members", memberId));
          alert("Member deleted successfully.");
          await loadMembers(); // Reload the member list
        } catch (error) {
          console.error("Error deleting member:", error);
          alert("Failed to delete member.");
        }
      }
    };

    // Placeholder functions
    window.exportToCSV = () => {
      alert("CSV export not implemented yet.");
    };

    window.cleanupOldPending = () => {
      alert("Cleanup not implemented yet.");
    };

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", async () => {
      await loadConversionRate();
      await loadMembers();
      await loadCashOutRequests(); // Load cash out requests
      const defaultBtn = document.querySelector('#tabButtons .tab-btn');
      if (defaultBtn) showTab('members', defaultBtn);
    });
  </script>

  <!-- Tab Navigation -->
  <script>
    function showTab(tabId, button = null) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tabId)?.classList.remove('hidden');
      document.querySelectorAll('#tabButtons .tab-btn').forEach(btn => {
        btn.classList.remove('bg-white', 'text-black');
        btn.classList.add('hover:underline');
      });
      if (button) {
        button.classList.remove('hover:underline');
        button.classList.add('bg-white', 'text-black');
      }
    }
  </script>
</body>
</html>
