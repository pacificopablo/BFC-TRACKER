<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Club - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

  <!-- Header -->
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">🎲 Baccarat Fund Club - Admin</h1>
    <button class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  </header>

  <!-- Tab Buttons -->
  <div id="tabButtons" class="flex space-x-4 text-sm font-semibold mb-6">
    <button onclick="showTab('members', this)" class="tab-btn px-3 py-1 rounded">👤 Members</button>
    <button onclick="showTab('requests', this)" class="tab-btn px-3 py-1 rounded">💸 Cash Outs</button>
    <button onclick="showTab('profits', this)" class="tab-btn px-3 py-1 rounded">📈 Profits</button>
    <button onclick="showTab('settings', this)" class="tab-btn px-3 py-1 rounded">⚙️ Settings</button>
  </div>

  <!-- 👤 Members Tab -->
  <section id="members" class="tab-content">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold">👥 Member List</h2>
      <button onclick="openAddModal()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">➕ Add Member</button>
    </div>
    <input type="text" id="searchInput" placeholder="🔍 Search by name" class="mb-4 p-2 w-full text-black rounded" />
    <div id="memberList" class="space-y-2"></div>
  </section>

  <!-- 💸 Cash Out Requests Tab -->
  <section id="requests" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">💸 Cash Out Requests</h2>
    <div id="requestList" class="space-y-2"></div>
  </section>

  <!-- 📈 Profit Distribution Tab -->
  <section id="profits" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">📊 Distribute Profits</h2>
    <form id="profitForm" class="space-y-2">
      <input type="number" id="totalProfit" class="border p-2 w-full text-black" placeholder="Enter total profit (PHP)" required />
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Distribute</button>
    </form>
    <div id="profitLogs" class="mt-4 space-y-2 text-sm text-gray-300"></div>
  </section>

  <!-- ⚙️ Settings Tab -->
  <section id="settings" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">⚙️ Settings</h2>
    <div class="space-y-2">
      <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded">📥 Export CSV</button>
      <button onclick="cleanupOldPending()" class="bg-yellow-500 text-white px-4 py-2 rounded ml-2">🧹 Clean Old Pending</button>
    </div>
  </section>

  <!-- ✏️ Edit Member Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-lg font-semibold mb-4">Edit Member</h3>
      <form id="editMemberForm" class="space-y-3">
        <input type="hidden" id="editMemberId" />
        <label class="block">Name: <input type="text" id="editName" class="border p-2 w-full" required /></label>
        <label class="block">Shares: <input type="number" id="editShares" class="border p-2 w-full" min="0" required /></label>
        <label class="block">Balance: <input type="number" id="editBalance" class="border p-2 w-full" min="0" required /></label>
        <label class="block">Status:
          <select id="editStatus" class="border p-2 w-full">
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="inactive">Inactive</option>
          </select>
        </label>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" onclick="closeEditModal()" class="px-3 py-1 bg-gray-400 rounded">Cancel</button>
          <button type="submit" class="px-4 py-1 bg-blue-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ➕ Add Member Modal -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-lg font-semibold mb-4">Add New Member</h3>
      <form id="addMemberForm" class="space-y-3">
        <label class="block">Name: <input type="text" id="addName" class="border p-2 w-full" required /></label>
        <label class="block">Shares: <input type="number" id="addShares" class="border p-2 w-full" min="0" required /></label>
        <label class="block">Balance: <input type="number" id="addBalance" class="border p-2 w-full" min="0" required /></label>
        <label class="block">Status:
          <select id="addStatus" class="border p-2 w-full">
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="inactive">Inactive</option>
          </select>
        </label>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" onclick="closeAddModal()" class="px-3 py-1 bg-gray-400 rounded">Cancel</button>
          <button type="submit" class="px-4 py-1 bg-green-600 text-white rounded">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, getDoc, updateDoc, doc, addDoc, deleteDoc, serverTimestamp,
      query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const profitForm = document.getElementById('profitForm');
    const profitLogs = document.getElementById('profitLogs');
    const requestList = document.getElementById('requestList');
    const memberList = document.getElementById('memberList');

    document.getElementById("searchInput").addEventListener("input", loadMembers);

    async function loadMembers() {
      memberList.innerHTML = '';
      const snapshot = await getDocs(collection(db, "members"));
      const members = [];

      snapshot.forEach(docSnap => {
        members.push({ id: docSnap.id, ...docSnap.data() });
      });

      const search = document.getElementById("searchInput").value.toLowerCase();
      const filtered = members.filter(m => m.name.toLowerCase().includes(search));

      filtered.forEach(data => {
        const div = document.createElement("div");
        div.className = "bg-white text-black p-4 rounded shadow";
        div.innerHTML = `
          <p><strong>${data.name}</strong> – ${data.shares} shares</p>
          <p>Balance: ₱${(data.balance || 0).toLocaleString()}</p>
          <p>Status: ${data.status || "unknown"}</p>
          <div class="mt-2 space-x-2">
            <button onclick="openEditModal('${data.id}', '${data.name}', ${data.shares}, ${data.balance || 0}, '${data.status || 'active'}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">✏️ Edit</button>
            <button onclick="deleteMember('${data.id}', '${data.name}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">🗑️ Delete</button>
          </div>
        `;
        memberList.appendChild(div);
      });
    }

    window.openEditModal = (id, name, shares, balance, status) => {
      document.getElementById('editMemberId').value = id;
      document.getElementById('editName').value = name;
      document.getElementById('editShares').value = shares;
      document.getElementById('editBalance').value = balance;
      document.getElementById('editStatus').value = status;
      document.getElementById('editModal').classList.remove('hidden');
    };
    window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');

    document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editMemberId').value;
      const name = document.getElementById('editName').value.trim();
      const shares = parseInt(document.getElementById('editShares').value);
      const balance = parseFloat(document.getElementById('editBalance').value);
      const status = document.getElementById('editStatus').value;

      await updateDoc(doc(db, "members", id), { name, shares, balance, status });
      alert("Member updated.");
      closeEditModal();
      loadMembers();
    });

    window.deleteMember = async (id, name) => {
      if (!confirm(`Delete member "${name}"?`)) return;
      const ref = doc(db, "members", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("Member not found.");
      const data = snap.data();
      if ((data.shares || 0) > 0 || (data.balance || 0) > 0) {
        return alert("❌ Cannot delete member with shares or balance.");
      }
      await deleteDoc(ref);
      await addDoc(collection(db, "admin_logs"), {
        action: `Deleted member ${name}`,
        timestamp: serverTimestamp()
      });
      alert(`✅ Member "${name}" deleted.`);
      loadMembers();
    };

    window.openAddModal = () => document.getElementById('addModal').classList.remove('hidden');
    window.closeAddModal = () => document.getElementById('addModal').classList.add('hidden');

    document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('addName').value.trim();
      const shares = parseInt(document.getElementById('addShares').value);
      const balance = parseFloat(document.getElementById('addBalance').value);
      const status = document.getElementById('addStatus').value;
      await addDoc(collection(db, "members"), {
        name, shares, balance, status, createdAt: serverTimestamp()
      });
      await addDoc(collection(db, "admin_logs"), {
        action: `Added member ${name}`,
        timestamp: serverTimestamp()
      });
      alert("✅ Member added.");
      e.target.reset();
      closeAddModal();
      loadMembers();
    });

    // Cash Out + Profits (keep existing logic)
    // Profit Logs, loadCashOutRequests, setupApproveButtons etc. remain here...

    await loadMembers();
  </script>

  <script>
    function showTab(tabId, button = null) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tabId)?.classList.remove('hidden');
      document.querySelectorAll('#tabButtons .tab-btn').forEach(btn => {
        btn.classList.remove('bg-white', 'text-black');
        btn.classList.add('hover:underline');
      });
      if (button) {
        button.classList.remove('hover:underline');
        button.classList.add('bg-white', 'text-black');
      }
    }
    document.addEventListener("DOMContentLoaded", () => {
      const defaultBtn = document.querySelector('#tabButtons .tab-btn');
      if (defaultBtn) showTab('members', defaultBtn);
    });
  </script>
</body>
</html>
