<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Club - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">ğŸ² Baccarat Fund Club - Admin</h1>
    <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded">Logout</button>
  </header>

  <!-- TABS -->
  <div id="tabButtons" class="flex space-x-4 text-sm font-semibold mb-6">
    <button onclick="showTab('members', this)" class="tab-btn px-3 py-1 rounded">ğŸ‘¤ Members</button>
    <button onclick="showTab('requests', this)" class="tab-btn px-3 py-1 rounded">ğŸ’¸ Cash Outs</button>
    <button onclick="showTab('profits', this)" class="tab-btn px-3 py-1 rounded">ğŸ“ˆ Profits</button>
    <button onclick="showTab('settings', this)" class="tab-btn px-3 py-1 rounded">âš™ï¸ Settings</button>
    <button onclick="showTab('charts', this)" class="tab-btn px-3 py-1 rounded">ğŸ“Š Charts</button>
  </div>

  <!-- MEMBERS TAB -->
  <section id="members" class="tab-content hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">ğŸ‘¥ Member List</h2>
      <button id="exportCsvBtn" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">ğŸ“¥ Export CSV</button>
    </div>
    <input
      id="searchInput"
      type="text"
      placeholder="Search members by name or email..."
      class="mb-2 p-2 rounded text-black w-full"
    />
    <div class="flex space-x-2 mb-4">
      <button id="sortNameBtn" class="bg-gray-700 px-3 py-1 rounded hover:bg-gray-600 text-sm">Sort Name â–²</button>
      <button id="sortSharesBtn" class="bg-gray-700 px-3 py-1 rounded hover:bg-gray-600 text-sm">Sort Shares â–²</button>
    </div>
    <div id="memberList" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
  </section>

  <!-- CASH OUTS TAB -->
  <section id="requests" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">ğŸ’¸ Cash Out Requests</h2>
    <div id="requestList"><p>Coming soonâ€¦</p></div>
  </section>

  <!-- PROFITS TAB -->
  <section id="profits" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">ğŸ“ˆ Profits</h2>
    <div id="profitList"><p>Coming soonâ€¦</p></div>
  </section>

  <!-- SETTINGS TAB -->
  <section id="settings" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">âš™ï¸ Settings</h2>
    <div class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">ğŸ”„ Conversion Rate (â‚± per share):</label>
        <input
          type="number"
          id="conversionRateInput"
          class="border p-2 w-full text-black"
          min="1"
          step="1"
        />
        <button onclick="updateConversionRate()" class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">ğŸ’¾ Save Rate</button>
      </div>
      <div>
        <button onclick="cleanupOldPending()" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-600">ğŸ§¹ Clean Old Pending</button>
      </div>
    </div>
  </section>

  <!-- CHARTS TAB -->
  <section id="charts" class="tab-content hidden p-4">
    <h2 class="text-lg font-semibold mb-4">ğŸ“Š Share Distribution</h2>
    <canvas id="sharesChart" width="400" height="300"></canvas>
  </section>

  <!-- EDIT MEMBER MODAL -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
    <div class="bg-gray-800 rounded p-6 w-96">
      <h3 class="text-xl font-semibold mb-4">Edit Member</h3>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editMemberId" />
        <div>
          <label class="block mb-1 font-medium">Name:</label>
          <input id="editName" type="text" class="w-full p-2 rounded text-black" required />
        </div>
        <div>
          <label class="block mb-1 font-medium">Email:</label>
          <input id="editEmail" type="email" class="w-full p-2 rounded text-black" required />
        </div>
        <div>
          <label class="block mb-1 font-medium">Shares:</label>
          <input id="editShares" type="number" class="w-full p-2 rounded text-black" min="0" step="1" required />
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeEditModal()" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script type="module">
    import { db } from './firebase-config.js';
    import {
      doc, getDoc, updateDoc,
      collection, getDocs, query, where, deleteDoc,
      Timestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import Chart from 'https://cdn.jsdelivr.net/npm/chart.js';

    let conversionRate = 10;
    let allMembers = [];
    let sortNameAsc = true;
    let sortSharesAsc = true;
    let currentSearchTerm = '';
    let sharesChart;

    // Load conversion rate
    async function loadConversionRate() {
      const snap = await getDoc(doc(db, 'settings', 'conversion'));
      if (snap.exists()) {
        conversionRate = snap.data().rate || 10;
        document.getElementById('conversionRateInput').value = conversionRate;
      }
    }

    // Update conversion rate
    window.updateConversionRate = async () => {
      const newRate = parseFloat(document.getElementById('conversionRateInput').value);
      if (isNaN(newRate) || newRate <= 0) return alert('Enter valid rate.');
      await updateDoc(doc(db, 'settings', 'conversion'), { rate: newRate });
      conversionRate = newRate;
      alert(`âœ… Rate set to â‚±${newRate}/share.`);
      loadAndRenderMembers();
    };

    // Load members from Firestore
    async function loadMembers() {
      const snap = await getDocs(collection(db, 'members'));
      allMembers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Render member list
    function renderMemberList(members) {
      const list = document.getElementById('memberList');
      list.innerHTML = '';
      if (members.length === 0) {
        list.innerHTML = '<p>No members found.</p>';
        return;
      }
      members.forEach(m => {
        const shares = m.shares || 0;
        const balance = shares * conversionRate;
        const card = document.createElement('div');
        card.className = 'bg-gray-800 p-4 rounded shadow flex justify-between items-center';
        card.innerHTML = `
          <div>
            <div class="font-semibold text-lg">${m.name || 'Unnamed'}</div>
            <div>Email: ${m.email || '-'}</div>
            <div>Shares: ${shares}</div>
            <div>Balance: â‚±${balance.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
          </div>
          <button class="edit-btn bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm">Edit</button>
        `;
        card.querySelector('.edit-btn').onclick = () => openEditModal(m);
        list.appendChild(card);
      });
      renderSharesChart(members);
    }

    // Apply search + sort
    function applyFiltersAndSort() {
      let filtered = allMembers.filter(m => {
        const term = currentSearchTerm.toLowerCase();
        return (m.name||'').toLowerCase().includes(term) || (m.email||'').toLowerCase().includes(term);
      });
      if (sortSharesAsc !== null) {
        filtered.sort((a,b) => sortSharesAsc ? (a.shares||0)-(b.shares||0) : (b.shares||0)-(a.shares||0));
      } else {
        filtered.sort((a,b) => {
          const A=(a.name||'').toLowerCase(), B=(b.name||'').toLowerCase();
          return sortNameAsc ? A.localeCompare(B) : B.localeCompare(A);
        });
      }
      renderMemberList(filtered);
    }

    // Combined load + render
    async function loadAndRenderMembers() {
      await loadMembers();
      applyFiltersAndSort();
    }

    // Search input
    document.getElementById('searchInput').oninput = e => {
      currentSearchTerm = e.target.value;
      applyFiltersAndSort();
    };

    // Sort buttons
    document.getElementById('sortNameBtn').onclick = () => {
      sortSharesAsc = null;
      sortNameAsc = !sortNameAsc;
      document.getElementById('sortNameBtn').textContent = `Sort Name ${sortNameAsc ? 'â–²' : 'â–¼'}`;
      document.getElementById('sortSharesBtn').textContent = 'Sort Shares â–²';
      applyFiltersAndSort();
    };
    document.getElementById('sortSharesBtn').onclick = () => {
      sortNameAsc = null;
      sortSharesAsc = !sortSharesAsc;
      document.getElementById('sortSharesBtn').textContent = `Sort Shares ${sortSharesAsc ? 'â–²' : 'â–¼'}`;
      document.getElementById('sortNameBtn').textContent = 'Sort Name â–²';
      applyFiltersAndSort();
    };

    // Edit modal
    function openEditModal(m) {
      document.getElementById('editMemberId').value = m.id;
      document.getElementById('editName').value    = m.name || '';
      document.getElementById('editEmail').value   = m.email || '';
      document.getElementById('editShares').value  = m.shares || 0;
      document.getElementById('editModal').classList.remove('hidden');
    }
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }
    window.closeEditModal = closeEditModal;

    document.getElementById('editForm').onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('editMemberId').value;
      const name  = document.getElementById('editName').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const shares= parseInt(document.getElementById('editShares').value);
      if (!name||!email||isNaN(shares)) return alert('Fill all fields.');
      await updateDoc(doc(db,'members',id), { name, email, shares });
      alert('âœ… Member updated.');
      closeEditModal();
      loadAndRenderMembers();
    };

    // CSV export
    document.getElementById('exportCsvBtn').onclick = () => {
      if (!allMembers.length) return alert('No members to export.');
      const hdr = ['Name','Email','Shares','Balance(â‚±)'];
      const rows = allMembers.map(m => {
        const bal = (m.shares||0)*conversionRate;
        return [`"${m.name||''}"`,`"${m.email||''}"`,m.shares||0,bal.toFixed(2)].join(',');
      });
      const csv = [hdr.join(','),...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `members_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
    };

    // Cleanup pending
    async function cleanupOldPending() {
      if (!confirm('Delete pending >7 days?')) return;
      const cutoff = new Date(Date.now() - 7*24*60*60*1000);
      const qSnap = await getDocs(query(collection(db,'members'), where('status','==','pending')));
      let del=0;
      for (const d of qSnap.docs) {
        const ts = d.data().createdAt;
        if (ts instanceof Timestamp && ts.toDate() < cutoff) {
          await deleteDoc(doc(db,'members',d.id));
          del++;
        }
      }
      alert(`Deleted ${del} old pending.`);
      loadAndRenderMembers();
    }
    window.cleanupOldPending = cleanupOldPending;

    // Charts
    function getRandomColor() {
      return '#' + Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0');
    }
    function renderSharesChart(members) {
      const ctx = document.getElementById('sharesChart').getContext('2d');
      const labels = members.map(m => m.name || 'Unnamed');
      const data   = members.map(m => m.shares || 0);
      if (sharesChart) sharesChart.destroy();
      sharesChart = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets:[{ data, backgroundColor: labels.map(getRandomColor) }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // Tab navigation
    function showTab(id,btn) {
      document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('#tabButtons .tab-btn').forEach(b=>{
        b.classList.remove('bg-white','text-black');
        b.classList.add('hover:underline');
      });
      if (btn) {
        btn.classList.remove('hover:underline');
        btn.classList.add('bg-white','text-black');
      }
    }
    window.showTab = showTab;

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await loadConversionRate();
      await loadAndRenderMembers();
      const first = document.querySelector('#tabButtons .tab-btn');
      if (first) showTab('members', first);
    });
  </script>
</body>
</html>
