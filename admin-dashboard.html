<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Baccarat Fund Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white p-4">
    <!-- [Previous HTML unchanged: Header, Summary Cards, Financial Chart, Distribute Profit/Loss, Member Search, Member List, Top Shareholders, Transaction Requests, Daily Distribution Report, Transaction History, Edit Member Modal] -->
    <script type="module">
      // [Previous Firebase imports unchanged]
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        onSnapshot,
        writeBatch,
        setDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // Firebase Configuration [unchanged]
      const firebaseConfig = {
        apiKey: "AIzaSyCN0dBQXoaWh_13lF0ON25otUpeH3OGINQ",
        authDomain: "bfc-tracker.firebaseapp.com",
        projectId: "bfc-tracker",
        storageBucket: "bfc-tracker.firebasestorage.app",
        messagingSenderId: "127052459580",
        appId: "1:127052459580:web:c3d5caa9302238c11cdd39",
        measurementId: "G-PNYRCFJHYM"
      };

      // Initialize Firebase [unchanged]
      let app, db, auth;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
      } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = '<p class="text-red-500 p-4">Failed to initialize Firebase. Please check configuration.</p>';
      }

      // DOM Elements [unchanged]
      const elements = {
        totalMembers: document.getElementById("totalMembers"),
        totalShares: document.getElementById("totalShares"),
        totalBalance: document.getElementById("totalBalance"),
        membersList: document.getElementById("membersList"),
        topShareholders: document.getElementById("topShareholders"),
        searchInput: document.getElementById("searchInput"),
        requestsList: document.getElementById("requestsList"),
        historyList: document.getElementById("historyList"),
        historyFilter: document.getElementById("historyFilter"),
        historySort: document.getElementById("historySort"),
        dailyReportList: document.getElementById("dailyReportList"),
        editModal: document.getElementById("editModal"),
        editForm: document.getElementById("editForm"),
        editMemberId: document.getElementById("editMemberId"),
        editName: document.getElementById("editName"),
        editEmail: document.getElementById("editEmail"),
        editStatus: document.getElementById("editStatus"),
        editShares: document.getElementById("editShares"),
        editBalance: document.getElementById("editBalance"),
        editApprovalDate: document.getElementById("editApprovalDate"),
        editLastDistribution: document.getElementById("editLastDistribution"),
        cancelEdit: document.getElementById("cancelEdit"),
        logoutBtn: document.getElementById("logoutBtn"),
        serverTimeBtn: document.getElementById("serverTimeBtn"),
        profitForm: document.getElementById("profitForm"),
        profitAmount: document.getElementById("profitAmount"),
        distributeBtn: document.getElementById("distributeBtn"),
        profitError: document.getElementById("profitError"),
        fundBalance: document.getElementById("fundBalance"),
        transactionType: document.getElementById("transactionType"),
      };

      let allMembers = [];
      let allTransactions = [];
      let lastSubmissionTime = 0;
      const SUBMISSION_COOLDOWN = 5000; // 5 seconds
      const HOURS_THRESHOLD = 24; // 24-hour eligibility threshold
      const SHARES_PER_AMOUNT = 10; // 1 share per ₱10 profit or loss

      // Utility Functions [unchanged]
      const formatCurrency = (value) =>
        parseFloat(value || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 });

      const showError = (element, message) => {
        element.textContent = message;
        element.classList.remove("hidden");
        setTimeout(() => element.classList.add("hidden"), 5000);
      };

      const showLoading = (element, message = "Loading...") => {
        element.innerHTML = `<p class="text-gray-400">${message}</p>`;
      };

      // Get Firebase Server Time [unchanged]
      async function getServerTimeAsDate() {
        try {
          const tempRef = doc(collection(db, "temp"));
          await setDoc(tempRef, { timestamp: serverTimestamp() });
          const docSnap = await getDoc(tempRef);
          if (docSnap.exists()) {
            const serverTime = docSnap.data().timestamp.toDate();
            await deleteDoc(tempRef); // Clean up
            return serverTime;
          }
          throw new Error("Failed to retrieve server time");
        } catch (error) {
          console.error("Error getting server time:", error);
          throw error;
        }
      }

      // Get start and end of current day in PHT (00:00 to 23:59 PHT) [unchanged]
      function getPHTDayRange(serverTime) {
        const phtTime = new Date(serverTime.getTime() + 8 * 60 * 60 * 1000); // Convert UTC to PHT
        const startOfDay = new Date(phtTime);
        startOfDay.setHours(0, 0, 0, 0); // 00:00 PHT
        const endOfDay = new Date(phtTime);
        endOfDay.setHours(23, 59, 59, 999); // 23:59 PHT
        return {
          start: new Date(startOfDay.getTime() - 8 * 60 * 60 * 1000), // UTC
          end: new Date(endOfDay.getTime() - 8 * 60 * 60 * 1000), // UTC
        };
      }

      // Check Member Eligibility [unchanged]
      async function isMemberEligible(member) {
        if (member.status !== "approved") return { eligible: false, reason: "Not Approved" };
        if (!member.balance || member.balance <= 0) return { eligible: false, reason: "Zero/Negative Balance" };
        const approvalDate = member.approvalDate ? new Date(member.approvalDate) : null;
        if (!approvalDate) return { eligible: false, reason: "No Approval Date" };

        try {
          const now = await getServerTimeAsDate();
          const hoursSinceApproval = (now - approvalDate) / (1000 * 60 * 60);
          if (hoursSinceApproval < HOURS_THRESHOLD) return { eligible: false, reason: "New Member (< 24 hrs)" };

          const lastDistribution = member.lastDistribution ? new Date(member.lastDistribution) : null;
          if (lastDistribution) {
            const { start } = getPHTDayRange(now);
            if (lastDistribution >= start) {
              return { eligible: false, reason: "Already Received Today" };
            }
          }

          return { eligible: true, reason: "Eligible" };
        } catch (error) {
          console.error("Error checking server time for eligibility:", error);
          return { eligible: false, reason: "Server Time Error" };
        }
      }

      // Load Fund Balance [unchanged]
      async function loadFundBalance() {
        try {
          const fundSnapshot = await getDocs(collection(db, "fund"));
          if (fundSnapshot.empty) {
            await setDoc(doc(db, "fund", "main"), { balance: 0 });
            elements.fundBalance.textContent = formatCurrency(0);
            return 0;
          }
          const fundDoc = fundSnapshot.docs[0];
          const balance = fundDoc.data().balance || 0;
          elements.fundBalance.textContent = formatCurrency(balance);
          return balance;
        } catch (error) {
          console.error("Error loading fund balance:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng fund balance: ${error.message}`);
          return 0;
        }
      }

      // Load Daily Distribution Report
      async function loadDailyReport() {
        showLoading(elements.dailyReportList, "Naglo-load ng daily report...");
        try {
          const now = await getServerTimeAsDate();
          const { start, end } = getPHTDayRange(now);
          const q = query(
            collection(db, "member_distributions"),
            orderBy("timestamp", "desc")
          );
          const snapshot = await getDocs(q);
          const todayDistributions = snapshot.docs.filter((doc) => {
            const timestamp = doc.data().timestamp?.toDate();
            return timestamp && timestamp >= start && timestamp <= end;
          });

          elements.dailyReportList.innerHTML = "";
          if (todayDistributions.length === 0) {
            elements.dailyReportList.innerHTML = '<p class="text-gray-400">Walang distribusyon ngayong araw.</p>';
            return;
          }

          todayDistributions.forEach((doc) => {
            const data = doc.data();
            let sharesText = "";
            if (data.sharesAdded > 0) {
              sharesText = `, Shares Added: ${data.sharesAdded}`;
            } else if (data.sharesAdded < 0) {
              sharesText = `, Shares Deducted: ${Math.abs(data.sharesAdded)}`;
            }
            const div = document.createElement("div");
            div.className = "bg-gray-700 p-4 rounded";
            div.innerHTML = `
              <p><strong>Miyembro:</strong> ${data.memberName || "N/A"}</p>
              <p><strong>Uri:</strong> ${data.type === "profit" ? "Profit" : "Loss"}</p>
              <p><strong>Halaga:</strong> ${data.type === "profit" ? "+" : "-"}₱${formatCurrency(data.amount)}${sharesText}</p>
              <p><strong>Petsa:</strong> ${data.timestamp?.toDate().toLocaleString("en-PH") || "N/A"}</p>
            `;
            elements.dailyReportList.appendChild(div);
          });
        } catch (error) {
          console.error("Error loading daily report:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng daily report: ${error.message}`);
          elements.dailyReportList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng daily report.</p>';
        }
      }

      // Authentication Check [unchanged]
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          showError(elements.profitError, "Hindi ka authenticated. Ire-redirect sa login...");
          setTimeout(() => (window.location.href = "/login.html"), 2000);
        } else {
          loadFundBalance().then(() => {
            loadMembers();
            listenForRequests();
            listenForTransactionHistory();
            loadDailyReport();
          });
        }
      });

      // Load Members [unchanged]
      async function loadMembers() {
        showLoading(elements.membersList, "Naglo-load ng mga miyembro...");
        showLoading(elements.topShareholders, "Naglo-load ng mga shareholder...");
        elements.totalMembers.textContent = "Naglo-load...";
        elements.totalShares.textContent = "Naglo-load...";
        elements.totalBalance.textContent = "Naglo-load...";

        try {
          const snapshot = await getDocs(collection(db, "users"));
          allMembers = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          if (allMembers.length === 0) {
            elements.membersList.innerHTML = '<p class="text-gray-400">Walang nahanap na miyembro.</p>';
            elements.topShareholders.innerHTML = '<p class="text-gray-400">Walang shareholders.</p>';
            elements.totalMembers.textContent = "0";
            elements.totalShares.textContent = "0";
            elements.totalBalance.textContent = formatCurrency(0);
          } else {
            console.log("Mga miyembrong nakuha mula sa users collection:", allMembers);
            await displayMembers(allMembers);
            updateTopShareholders();
          }
        } catch (error) {
          console.error("Error sa pag-load ng mga miyembro mula sa users collection:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng mga miyembro: ${error.message}`);
          elements.membersList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng mga miyembro.</p>';
          elements.totalMembers.textContent = "0";
          elements.totalShares.textContent = "0";
          elements.totalBalance.textContent = formatCurrency(0);
        }
      }

      // Display Members [unchanged]
      async function displayMembers(members) {
        let memberCount = 0,
          shareTotal = 0,
          balanceTotal = 0;
        elements.membersList.innerHTML = "";

        for (const m of members) {
          memberCount++;
          shareTotal += m.shares || 0;
          balanceTotal += m.balance || 0;

          const eligibility = await isMemberEligible(m);
          const lastDistributionText = m.lastDistribution
            ? new Date(m.lastDistribution).toLocaleString("en-PH")
            : "None";

          const div = document.createElement("div");
          div.className = "bg-gray-800 p-4 rounded shadow";
          div.innerHTML = `
            <p><strong>Pangalan:</strong> ${m.name || "N/A"}</p>
            <p><strong>Email:</strong> ${m.email || "N/A"}</p>
            <p><strong>Status:</strong> <span class="px-2 py-1 rounded ${
              m.status === "approved"
                ? "bg-green-600"
                : m.status === "pending"
                ? "bg-yellow-600"
                : "bg-red-600"
            }">${m.status || "N/A"}</span></p>
            <p><strong>Shares:</strong> ${m.shares || 0}</p>
            <p><strong>Balance:</strong> ₱${formatCurrency(m.balance)}</p>
            <p><strong>Eligible for Profit/Loss:</strong> ${eligibility.eligible ? "Yes" : `No (${eligibility.reason})`}</p>
            <p><strong>Last Distribution:</strong> ${lastDistributionText}</p>
            <div class="flex space-x-2 mt-2">
              <button data-id="${m.id}" class="edit-btn bg-blue-600 px-3 py-1 rounded text-sm">I-edit</button>
              <button data-id="${m.id}" data-name="${
                m.name || "Unknown"
              }" class="delete-btn bg-red-600 px-3 py-1 rounded text-sm">I-delete</button>
            </div>
          `;
          elements.membersList.appendChild(div);
        }

        elements.totalMembers.textContent = memberCount;
        elements.totalShares.textContent = shareTotal;
        elements.totalBalance.textContent = formatCurrency(balanceTotal);
      }

      // Update Top Shareholders [unchanged]
      async function updateTopShareholders() {
        const top = [];
        for (const m of allMembers) {
          const eligibility = await isMemberEligible(m);
          if (m.status === "approved" && eligibility.eligible) {
            top.push(m);
          }
        }
        top.sort((a, b) => (b.shares || 0) - (a.shares || 0)).slice(0, 5);

        elements.topShareholders.innerHTML = "";
        if (top.length === 0) {
          elements.topShareholders.innerHTML = '<p class="text-gray-400">Walang eligible na shareholders.</p>';
        } else {
          top.forEach((m) => {
            const li = document.createElement("li");
            li.textContent = `${m.name || "N/A"} — ${m.shares || 0} shares`;
            elements.topShareholders.appendChild(li);
          });
        }
      }

      // Search Members [unchanged]
      elements.searchInput.addEventListener("input", async () => {
        const query = elements.searchInput.value.toLowerCase();
        const filtered = allMembers.filter(
          (m) =>
            (m.name || "").toLowerCase().includes(query) ||
            (m.email || "").toLowerCase().includes(query) ||
            (m.status || "").toLowerCase().includes(query)
        );
        await displayMembers(filtered);
      });

      // Listen for Transaction Requests [unchanged]
      function listenForRequests() {
        showLoading(elements.requestsList, "Naglo-load ng mga kahilingan...");
        const q = query(collection(db, "transactions"), orderBy("timestamp", "desc"));
        onSnapshot(
          q,
          (snapshot) => {
            elements.requestsList.innerHTML = "";
            const pendingRequests = snapshot.docs.filter((doc) => doc.data().status === "pending");
            if (pendingRequests.length === 0) {
              elements.requestsList.innerHTML = '<p class="text-gray-400">Walang pending na kahilingan.</p>';
            } else {
              pendingRequests.forEach((docSnap) => {
                const data = docSnap.data();
                const div = document.createElement("div");
                div.className = "bg-gray-700 p-4 rounded";
                div.innerHTML = `
                  <p><strong>Miyembro:</strong> ${data.memberName || "N/A"}</p>
                  <p><strong>Uri:</strong> ${data.type || "N/A"}</p>
                  <p><strong>Halaga:</strong> ₱${formatCurrency(data.amount)}</p>
                  <p><strong>Petsa:</strong> ${
                    data.timestamp?.toDate().toLocaleString() || "N/A"
                  }</p>
                  <div class="flex space-x-2 mt-2">
                    <button data-id="${docSnap.id}" class="approve-btn bg-green-600 px-3 py-1 rounded text-sm">Approve</button>
                    <button data-id="${docSnap.id}" class="reject-btn bg-red-600 px-3 py-1 rounded text-sm">Reject</button>
                  </div>
                `;
                elements.requestsList.appendChild(div);
              });
            }
          },
          (error) => {
            console.error("Error sa pag-load ng mga kahilingan:", error);
            showError(elements.profitError, `Nabigo sa pag-load ng mga kahilingan: ${error.message}`);
            elements.requestsList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng mga kahilingan.</p>';
          }
        );
      }

      // Listen for Transaction History [unchanged]
      function listenForTransactionHistory() {
        showLoading(elements.historyList, "Naglo-load ng kasaysayan ng transaksyon...");
        const profitQuery = query(collection(db, "profit_distributions"), orderBy("timestamp", "desc"));
        const transactionQuery = query(collection(db, "transactions"), orderBy("timestamp", "desc"));

        onSnapshot(profitQuery, (profitSnapshot) => {
          onSnapshot(transactionSnapshot, (transactionSnapshot) => {
            allTransactions = [];

            profitSnapshot.docs.forEach((doc) => {
              const data = doc.data();
              allTransactions.push({
                id: doc.id,
                type: data.type === "profit" ? "Profit Distribution" : "Loss Deduction",
                filterType: data.type,
                amount: data.amount,
                timestamp: data.timestamp?.toDate() || new Date(),
                details: `Distributed to ${data.eligibleMemberCount} of ${data.totalMemberCount} members, Total Shares: ${data.totalShares}`,
              });
            });

            transactionSnapshot.docs.forEach((doc) => {
              const data = doc.data();
              allTransactions.push({
                id: doc.id,
                type: data.type === "deposit" ? "Deposit" : "Cash Out",
                filterType: data.type === "deposit" ? "deposit" : "cashout",
                amount: data.amount,
                timestamp: data.timestamp?.toDate() || new Date(),
                details: `Member: ${data.memberName || "N/A"}, Status: ${data.status || "N/A"}`,
              });
            });

            displayTransactionHistory();
          }, (error) => {
            console.error("Error sa pag-load ng mga transaksyon:", error);
            showError(elements.profitError, `Nabigo sa pag-load ng kasaysayan ng transaksyon: ${error.message}`);
            elements.historyList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng kasaysayan ng transaksyon.</p>';
          });
        }, (error) => {
          console.error("Error sa pag-load ng mga pamimigay ng profit/loss:", error);
          showError(elements.profitError, `Nabigo sa pag-load ng kasaysayan ng transaksyon: ${error.message}`);
          elements.historyList.innerHTML = '<p class="text-red-500">Nabigo sa pag-load ng kasaysayan ng transaksyon.</p>';
        });
      }

      // Display Transaction History [unchanged]
      function displayTransactionHistory() {
        const filter = elements.historyFilter.value;
        const sort = elements.historySort.value;

        let filteredTransactions = allTransactions;
        if (filter !== "all") {
          filteredTransactions = allTransactions.filter((txn) => txn.filterType === filter);
        }

        filteredTransactions.sort((a, b) =>
          sort === "desc" ? b.timestamp - a.timestamp : a.timestamp - b.timestamp
        );

        elements.historyList.innerHTML = "";
        if (filteredTransactions.length === 0) {
          elements.historyList.innerHTML = '<p class="text-gray-400">Walang kasaysayan ng transaksyon para sa napiling filter.</p>';
          return;
        }

        filteredTransactions.forEach((txn) => {
          const div = document.createElement("div");
          div.className = "bg-gray-700 p-4 rounded";
          div.innerHTML = `
            <p><strong>Uri:</strong> ${txn.type}</p>
            <p><strong>Halaga:</strong> ₱${formatCurrency(txn.amount)}</p>
            <p><strong>Petsa:</strong> ${txn.timestamp.toLocaleString()}</p>
            <p><strong>Mga Detalye:</strong> ${txn.details}</p>
          `;
          elements.historyList.appendChild(div);
        });
      }

      // Transaction History Filter and Sort [unchanged]
      elements.historyFilter.addEventListener("change", displayTransactionHistory);
      elements.historySort.addEventListener("change", displayTransactionHistory);

      // Logout Functionality [unchanged]
      elements.logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          console.log("Matagumpay na nag-logout ang user");
          window.location.href = "/login.html";
        } catch (error) {
          console.error("Error sa pag-logout:", error);
          showError(elements.profitError, `Nabigo sa pag-logout: ${error.message}`);
        }
      });

      // Check Server Time [unchanged]
      elements.serverTimeBtn.addEventListener("click", async () => {
        try {
          const serverTime = await getServerTimeAsDate();
          alert(`Server Time: ${serverTime.toLocaleString()} (Local), ${serverTime.toISOString()} (UTC)`);
        } catch (error) {
          showError(elements.profitError, `Failed to retrieve server time: ${error.message}`);
        }
      });

      // Distribute Profit/Loss Functionality
      elements.profitForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const currentTime = Date.now();
        if (currentTime - lastSubmissionTime < SUBMISSION_COOLDOWN) {
          showError(elements.profitError, `Maghintay ng ${Math.ceil((SUBMISSION_COOLDOWN - (currentTime - lastSubmissionTime)) / 1000)} segundo bago muling mag-submit.`);
          return;
        }
        lastSubmissionTime = currentTime;

        elements.distributeBtn.disabled = true;
        elements.distributeBtn.textContent = "Pinoproseso...";

        try {
          const transactionType = elements.transactionType.value;
          const amount = parseFloat(elements.profitAmount.value);
          if (isNaN(amount) || amount <= 0) {
            showError(elements.profitError, "Maglagay ng valid na halaga na higit sa 0.");
            return;
          }

          const fundSnapshot = await getDocs(collection(db, "fund"));
          if (fundSnapshot.empty) {
            showError(elements.profitError, "Walang fund data. I-initialize ang fund balance.");
            return;
          }
          const fundDoc = fundSnapshot.docs[0];
          const fundBalance = fundDoc.data().balance || 0;

          // Calculate total shares from all members with positive shares
          const membersWithShares = allMembers.filter((m) => (m.shares || 0) > 0);
          const totalShares = membersWithShares.reduce((sum, m) => sum + (m.shares || 0), 0);
          if (totalShares === 0) {
            showError(elements.profitError, "Walang miyembro na may shares.");
            return;
          }

          const amountPerShare = amount / totalShares;
          const batch = writeBatch(db);
          let totalFundChange = 0;
          let eligibleMemberCount = 0;

          // Create a profit_distributions document first to get its ID
          const distributionRef = doc(collection(db, "profit_distributions"));
          const distributionId = distributionRef.id;

          // Process eligible members
          for (const member of membersWithShares) {
            const eligibility = await isMemberEligible(member);
            if (eligibility.eligible) {
              const currentBalance = member.balance || 0;
              const currentShares = member.shares || 0;
              let newBalance, newShares, sharesChange;
              const memberDistributionAmount = currentShares * amountPerShare;

              if (transactionType === "profit") {
                newBalance = currentBalance + memberDistributionAmount;
                sharesChange = Math.floor(memberDistributionAmount / SHARES_PER_AMOUNT);
                newShares = currentShares + sharesChange;
                totalFundChange += memberDistributionAmount;
              } else {
                newBalance = Math.max(0, currentBalance - memberDistributionAmount);
                sharesChange = -Math.floor(memberDistributionAmount / SHARES_PER_AMOUNT);
                newShares = Math.max(0, currentShares + sharesChange);
                totalFundChange -= memberDistributionAmount;
              }

              const userRef = doc(db, "users", member.id);
              batch.update(userRef, {
                balance: newBalance,
                shares: newShares,
                lastDistribution: serverTimestamp(),
              });

              // Log individual member distribution
              const memberDistRef = doc(collection(db, "member_distributions"));
              batch.set(memberDistRef, {
                memberId: member.id,
                memberName: member.name || "N/A",
                type: transactionType,
                amount: memberDistributionAmount,
                sharesAdded: sharesChange,
                timestamp: serverTimestamp(),
                distributionId: distributionId,
              });

              console.log(
                `${transactionType === "profit" ? "Idinagdag" : "Ibinawas"} ₱${formatCurrency(
                  memberDistributionAmount
                )} sa ${member.name || "N/A"} (Bagong balance: ₱${formatCurrency(newBalance)}, Bagong shares: ${newShares})`
              );
              eligibleMemberCount++;
            }
          }

          // Update fund balance
          const fundRef = doc(db, "fund", fundDoc.id);
          const newFundBalance = fundBalance + (transactionType === "profit" ? totalFundChange : -totalFundChange);
          if (newFundBalance < 0) {
            showError(elements.profitError, "Ang transaksyon ay magreresulta sa negatibong fund balance.");
            return;
          }
          batch.update(fundRef, { balance: newFundBalance });

          // Log distribution
          batch.set(distributionRef, {
            type: transactionType,
            amount: amount,
            timestamp: serverTimestamp(),
            adminId: auth.currentUser?.uid || "unknown",
            eligibleMemberCount,
            totalMemberCount: membersWithShares.length,
            totalShares,
          });

          await batch.commit();

          elements.profitForm.reset();
          await loadMembers();
          await loadFundBalance();
          await loadDailyReport();
          alert(
            `Matagumpay na ${transactionType === "profit" ? "ipinadistribute" : "ibinawas"} ang ₱${formatCurrency(
              amount
            )} sa ${eligibleMemberCount} ng ${membersWithShares.length} miyembro!`
          );
        } catch (error) {
          console.error(`Error ${transactionType === "profit" ? "distributing profit" : "deducting loss"}:`, error);
          showError(elements.profitError, `Nabigo ang ${transactionType === "profit" ? "pamimigay ng profit" : "pagbabawas ng loss"}: ${error.message}`);
        } finally {
          elements.distributeBtn.disabled = false;
          elements.distributeBtn.textContent = "Distribute";
        }
      });

      // Edit Member Functions [unchanged]
      function openEditModal(member) {
        if (!member || !member.id) {
          console.error("Invalid member data:", member);
          showError(elements.profitError, "Hindi mae-edit: Invalid ang data ng miyembro.");
          return;
        }
        elements.editMemberId.value = member.id;
        elements.editName.value = member.name || "";
        elements.editEmail.value = member.email || "";
        elements.editStatus.value = member.status || "pending";
        elements.editShares.value = member.shares || 0;
        elements.editBalance.value = member.balance || 0;
        elements.editApprovalDate.value = member.approvalDate 
          ? new Date(member.approvalDate).toISOString().slice(0, 16)
          : new Date().toISOString().slice(0, 16);
        elements.editLastDistribution.value = member.lastDistribution
          ? new Date(member.lastDistribution).toISOString().slice(0, 16)
          : "";
        elements.editModal.classList.remove("hidden");
      }

      elements.editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = elements.editMemberId.value;
        const shares = parseInt(elements.editShares.value);
        const balance = parseFloat(elements.editBalance.value);
        const status = elements.editStatus.value;
        const approvalDate = elements.editApprovalDate.value
          ? new Date(elements.editApprovalDate.value).toISOString()
          : new Date().toISOString();

        if (isNaN(shares) || shares < 0 || isNaN(balance) || balance < 0) {
          showError(elements.profitError, "Ang shares at balance ay dapat na hindi negatibo.");
          return;
        }

        const memberRef = doc(db, "users", id);
        const memberSnap = await getDoc(memberRef);
        const currentMemberData = memberSnap.exists() ? memberSnap.data() : {};

        let updatedApprovalDate = currentMemberData.approvalDate || approvalDate;
        if (status === "approved" && !currentMemberData.approvalDate) {
          updatedApprovalDate = new Date().toISOString();
        }

        const updatedData = {
          name: elements.editName.value,
          email: elements.editEmail.value,
          status: status,
          shares,
          balance,
          approvalDate: updatedApprovalDate,
          lastDistribution: currentMemberData.lastDistribution || null,
        };

        try {
          await updateDoc(memberRef, updatedData);
          elements.editModal.classList.add("hidden");
          await loadMembers();
          await loadDailyReport();
          alert("Matagumpay na na-update ang miyembro!");
        } catch (error) {
          console.error("Error sa pag-update ng miyembro sa users collection:", error);
          showError(elements.profitError, `Nabigo sa pag-update ng miyembro: ${error.message}`);
        }
      });

      elements.cancelEdit.addEventListener("click", () => {
        elements.editModal.classList.add("hidden");
      });

      // Delete Member [unchanged]
      async function deleteMember(id, name) {
        if (confirm(`Sigurado ka bang gusto mong i-delete si ${name || "miyembrong ito"}?`)) {
          try {
            await deleteDoc(doc(db, "users", id));
            await loadMembers();
            await loadDailyReport();
            alert("Matagumpay na na-delete ang miyembro!");
          } catch (error) {
            console.error("Error sa pag-delete ng miyembro mula sa users collection:", error);
            showError(elements.profitError, `Nabigo sa pag-delete ng miyembro: ${error.message}`);
          }
        }
      }

      // Event Delegation for Edit, Delete, Approve, and Reject Buttons [unchanged]
      elements.membersList.addEventListener("click", (e) => {
        const target = e.target;
        const id = target.dataset.id;
        if (target.classList.contains("edit-btn") && id) {
          const member = allMembers.find((m) => m.id === id);
          if (member) openEditModal(member);
          else showError(elements.profitError, "Hindi nahanap ang data ng miyembro.");
        } else if (target.classList.contains("delete-btn") && id) {
          const name = target.dataset.name;
          deleteMember(id, name);
        }
      });

      elements.requestsList.addEventListener("click", async (e) => {
        const target = e.target;
        const id = target.dataset.id;

        if (target.classList.contains("approve-btn") && id) {
          await updateTransactionStatus(id, "approved");
          alert("Matagumpay na naaprubahan ang kahilingan!");
        } else if (target.classList.contains("reject-btn") && id) {
          await updateTransactionStatus(id, "rejected");
          alert("Matagumpay na na-reject ang kahilingan!");
        }
      });

      // Update Transaction Status [unchanged]
      async function updateTransactionStatus(transactionId, status) {
        try {
          const transactionRef = doc(db, "transactions", transactionId);
          await updateDoc(transactionRef, { status: status });
        } catch (error) {
          console.error("Error sa pag-update ng status ng transaksyon:", error);
          showError(elements.profitError, `Nabigo sa pag-update ng status: ${error.message}`);
        }
      }

      // Initialize Chart [unchanged]
      try {
        const ctx = document.getElementById("fundChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Fund Balance",
                data: [15000, 18000, 21000, 25000, 29000, 34000],
                backgroundColor: "rgba(59, 130, 246, 0.2)",
                borderColor: "rgba(59, 130, 246, 1)",
                borderWidth: 2,
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: "white" } } },
            scales: {
              x: { ticks: { color: "white" } },
              y: { ticks: { color: "white" }, beginAtZero: true },
            },
          },
        });
        console.log("Matagumpay na na-initialize ang chart");
      } catch (error) {
        console.error("Error sa pag-initialize ng chart:", error);
        document.getElementById("fundChart").parentElement.innerHTML =
          '<p class="text-red-500">Nabigo sa pag-load ng chart.</p>';
      }
    </script>
  </body>
</html>
