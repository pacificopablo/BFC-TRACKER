<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baccarat Fund Club - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

  <!-- Header -->
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">ğŸ² Baccarat Fund Club - Admin</h1>
    <button class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  </header>

  <!-- Tab Buttons -->
  <div id="tabButtons" class="flex space-x-4 text-sm font-semibold mb-6">
    <button onclick="showTab('members', this)" class="tab-btn px-3 py-1 rounded">ğŸ‘¤ Members</button>
    <button onclick="showTab('requests', this)" class="tab-btn px-3 py-1 rounded">ğŸ’¸ Cash Outs</button>
    <button onclick="showTab('profits', this)" class="tab-btn px-3 py-1 rounded">ğŸ“ˆ Profits</button>
    <button onclick="showTab('settings', this)" class="tab-btn px-3 py-1 rounded">âš™ï¸ Settings</button>
  </div>

  <!-- ğŸ‘¤ Members Tab -->
  <section id="members" class="tab-content">
    <h2 class="text-lg font-semibold mb-2">ğŸ‘¥ Member List</h2>
    <div class="bg-white text-black p-4 rounded shadow">
      <p>Sample member record: <strong>Maria Santos</strong> â€“ 150 shares</p>
    </div>
  </section>

  <!-- ğŸ’¸ Cash Out Requests Tab -->
  <section id="requests" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">ğŸ’¸ Cash Out Requests</h2>
    <div id="requestList" class="space-y-2">
      <div class="bg-white text-black p-4 rounded shadow">
        <p><strong>Name:</strong> Juan Dela Cruz</p>
        <p><strong>Amount:</strong> â‚±5,000</p>
        <p><strong>Date:</strong> July 6, 2025</p>
        <div class="mt-2">
          <button class="bg-green-500 text-white px-3 py-1 rounded mr-2">Approve</button>
          <button class="bg-red-500 text-white px-3 py-1 rounded">Reject</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ“ˆ Profit Distribution Tab -->
  <section id="profits" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">ğŸ“Š Distribute Profits</h2>
    <form id="profitForm" class="space-y-2">
      <input type="number" id="totalProfit" class="border p-2 w-full text-black" placeholder="Enter total profit (PHP)" required />
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Distribute</button>
    </form>
    <div id="profitLogs" class="mt-4 space-y-2 text-sm text-gray-300">
      <!-- Logs will appear here -->
    </div>
  </section>

  <!-- âš™ï¸ Settings Tab -->
  <section id="settings" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">âš™ï¸ Settings</h2>
    <div class="space-y-2">
      <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ“¥ Export CSV</button>
      <button onclick="cleanupOldPending()" class="bg-yellow-500 text-white px-4 py-2 rounded ml-2">ğŸ§¹ Clean Old Pending</button>
    </div>
  </section>

  <!-- Firebase Logic -->
  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, updateDoc, doc, addDoc,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const profitForm = document.getElementById('profitForm');
    const profitLogs = document.getElementById('profitLogs');

    async function loadProfitLogs() {
      profitLogs.innerHTML = '';
      const q = query(collection(db, "profit_logs"), orderBy("date", "desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const logDiv = document.createElement("div");
        logDiv.className = "bg-gray-800 p-2 rounded";
        logDiv.textContent = data.message;
        profitLogs.appendChild(logDiv);
      });
    }

    await loadProfitLogs();

    profitForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const totalProfit = parseFloat(document.getElementById('totalProfit').value);
      if (isNaN(totalProfit) || totalProfit <= 0) {
        alert("Enter a valid profit amount.");
        return;
      }

      const membersSnapshot = await getDocs(collection(db, "members"));
      const members = [];
      let totalShares = 0;

      membersSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.status === "active" && data.shares > 0) {
          members.push({ id: docSnap.id, ...data });
          totalShares += data.shares;
        }
      });

      if (totalShares === 0) {
        alert("No active members with shares.");
        return;
      }

      const updates = members.map(async (member) => {
        const ratio = member.shares / totalShares;
        const profitShare = parseFloat((totalProfit * ratio).toFixed(2));
        const newBalance = (member.balance || 0) + profitShare;

        await updateDoc(doc(db, "members", member.id), {
          balance: newBalance
        });
      });

      await Promise.all(updates);

      const dateStr = new Date().toLocaleDateString("en-PH", { month: 'long', day: 'numeric' });
      const logMsg = `ğŸ“¢ ${dateStr} â€“ â‚±${totalProfit.toLocaleString()} profit distributed across ${members.length} members.`;

      const logDiv = document.createElement("div");
      logDiv.className = "bg-gray-800 p-2 rounded";
      logDiv.textContent = logMsg;
      profitLogs.prepend(logDiv);

      await addDoc(collection(db, "profit_logs"), {
        date: serverTimestamp(),
        message: logMsg,
        totalProfit,
        totalMembers: members.length,
      });

      alert("Profit distributed and logged.");
      profitForm.reset();
    });

    // Optional stub functions
    window.exportToCSV = function () {
      alert("Export to CSV not implemented.");
    };
    window.cleanupOldPending = function () {
      alert("Auto cleanup not implemented.");
    };
  </script>

  <!-- Tab Navigation -->
  <script>
    function showTab(tabId, button = null) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.add('hidden'));
      const target = document.getElementById(tabId);
      if (target) target.classList.remove('hidden');

      const allButtons = document.querySelectorAll('#tabButtons .tab-btn');
      allButtons.forEach(btn => {
        btn.classList.remove('bg-white', 'text-black');
        btn.classList.add('hover:underline');
      });

      if (button) {
        button.classList.remove('hover:underline');
        button.classList.add('bg-white', 'text-black');
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const defaultBtn = document.querySelector('#tabButtons .tab-btn');
      if (defaultBtn) showTab('members', defaultBtn);
    });
  </script>
</body>
</html>
